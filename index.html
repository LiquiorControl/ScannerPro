<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Bar Control</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- 5. Chart.js (Esencial para el gr√°fico circular) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 6. jsPDF & AutoTable (Para generaci√≥n de PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- 7. Google Fonts (Solo Roboto para consistencia simple) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* DARK THEME GLOBAL */
        :root {
            --theme-font: 'Roboto', sans-serif;
            --theme-text-color: #f0f6fc;
        }
        
        body { 
            background-color: #0A0A0A; 
            color: var(--theme-text-color); 
            font-family: var(--theme-font), system-ui, sans-serif; 
            min-height: 100vh; 
        }
        
        .animate-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(29, 31, 35, 0.5); }
        ::-webkit-scrollbar-thumb { background: #3A4048; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #484f58; }
        
        /* Scanner */
        #reader { border: none !important; }
        #reader video { border-radius: 12px; object-fit: cover; width: 100% !important; }
        
        /* Custom size h-21 w-21 */
        .h-21 { height: 5.25rem; } /* 84px */
        .w-21 { width: 5.25rem; } /* 84px */
        
        /* Location Tabs Scroll Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* FIX: Canvas moved off-screen but kept 'visible' for rendering engine */
        #pdf-chart-canvas { 
            position: fixed; 
            left: 100vw; /* Push off screen to the right */
            top: 0;
            z-index: -100;
            background-color: white; /* Ensure white background */
            display: block; /* Ensure it's part of layout */
        }
        
        /* Saving Indicator Pulse */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .saving-pulse { animation: pulse-green 2s infinite; }

        /* Login Screen Animation */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* Floating Number Animation */
        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-20px) scale(1.2); }
        }
        .animate-float { animation: float-up 0.8s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; align-items: center; justify-content: center; color: rgba(240, 246, 252, 0.5);">
            Loading Master Bar Control...
        </div>
    </div>
    
    <!-- Hidden Canvas for generating chart images for PDF -->
    <canvas id="pdf-chart-canvas" width="500" height="500"></canvas>

    <!-- FIREBASE MODULES - Loaded safely -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        window.fb = { initializeApp, getFirestore, doc, setDoc, onSnapshot, getDoc, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Component } = React;

        // ==========================================
        // üõ†Ô∏è SAFE STORAGE HELPER
        // ==========================================
        const SafeStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } catch (e) { console.warn("Storage access denied"); return null; }
            },
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } catch (e) { console.warn("Storage write denied"); }
            }
        };

        // ==========================================
        // ‚ÑπÔ∏è VERSI√ìN DE LA APP
        // ==========================================
        const APP_VERSION = "3.5.1";

        // ==========================================
        // üîë CONFIGURACI√ìN FIREBASE
        // ==========================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBbyENQwbbPzbwpxd9WIVIkaZP1zYkn8X4",
            authDomain: "liquor-control.firebaseapp.com",
            projectId: "liquor-control",
            storageBucket: "liquor-control.firebasestorage.app",
            messagingSenderId: "221278168324",
            appId: "1:221278168324:web:b763c0bc4c1020d40d1c51"
        };

        // ==========================================
        // üìã PAR LEVELS
        // ==========================================
        const PAR_LEVELS = {
            "Crown Royal Regal": 2, "Apple Crown Royal": 2, "Jack Daniels Black": 4, "Jameson": 2, "WoodFord Reserve": 1,
            "Buchanans 12": 6, "Johnnie Walker Black": 4, "Grand Old Parr 12": 2, "Hennessy VS": 3, "Tito's Texas Vodka": 3,
            "Remy Martin": 1, "Grey Goose": 3, "Casamigos Blanco": 4, "Casamigos Reposado": 2, "Espolon Blanco": 2,
            "Espolon Reposado": 1, "Don Julio Blanco": 6, "Don Julio Reposado": 2, "Patron Silver": 6, "Patron Reposado": 1,
            "Fernet Branca": 2, "Brugal Anejo": 1, "Montezuma White": 12, "Barton Naturals Vodka": 12, "Long Island Tea Mix": 6,
            "Peach Schnapps Boston": 12, "Triple Sec Boston": 12, "Bacardi Light": 6,
            "Modelo Especial": 600, "Corona": 720, "Michelob Ultra": 96, "Heineken": 48, "Pacifico": 72,
            "Red Bull Regular": 96, "Red Bull Sugar Free": 96, "Red Bull Watermelon": 72,
            "Cafayate Malbec": 6,
            "Coca Cola": 48, "Diet Coke": 24, "Sprite": 48, "Ginger Ale": 24, "Water Bottle": 96
        };

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) return <div className="p-10 text-center text-red-400 bg-gray-900 h-screen flex flex-col justify-center items-center"><div>Application Error. Reload Page.</div><div className="text-xs mt-2 opacity-50">{this.state.error?.toString()}</div></div>;
                return this.props.children;
            }
        }

        // --- ICONS ---
        const IconWrapper = ({ children, className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Beer: (p) => <IconWrapper {...p}><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M9 12h6"/><path d="M9 12v3a8 8 0 0 1-16 0v-3"/><path d="M22 6h-7a2 2 0 0 0-2 2v2"/><path d="M5 12V3a2 2 0 0 1 2-2h7"/></IconWrapper>,
            Wine: (p) => <IconWrapper {...p}><path d="M8 22h8"/><path d="M7 10h10"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/></IconWrapper>,
            GlassWater: (p) => <IconWrapper {...p}><path d="M15.2 22H8.8a2 2 0 0 1-2-1.79L5 3h14l-1.81 17.21A2 2 0 0 1 15.2 22Z"/><path d="M6 12a5 5 0 0 1 6 0 5 5 0 0 0 6 0"/></IconWrapper>,
            Package: (p) => <IconWrapper {...p}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Search: (p) => <IconWrapper {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
            Download: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>,
            ChevronDown: (p) => <IconWrapper {...p}><path d="m6 9 6 6 6-6"/></IconWrapper>,
            ChevronUp: (p) => <IconWrapper {...p}><path d="m18 15-6-6-6 6"/></IconWrapper>,
            AlertTriangle: (p) => <IconWrapper {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconWrapper>,
            CheckCircle: (p) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></IconWrapper>,
            RotateCcw: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>,
            Calculator: (p) => <IconWrapper {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>,
            MapPin: (p) => <IconWrapper {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            DollarSign: (p) => <IconWrapper {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconWrapper>,
            ShoppingCart: (p) => <IconWrapper {...p}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconWrapper>,
            RefreshCw: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>,
            Box: (p) => <IconWrapper {...p}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            ArrowRight: (p) => <IconWrapper {...p}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconWrapper>,
            Trash: (p) => <IconWrapper {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></IconWrapper>,
            BarChart: (p) => <IconWrapper {...p}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></IconWrapper>,
            Cloud: (p) => <IconWrapper {...p}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19c3.037 0 5.5-2.463 5.5-5.5S20.537 8 17.5 8"/><path d="M17.5 8c0-3.037-2.463-5.5-5.5-5.5S6.5 4.963 6.5 8"/><path d="M6.5 19C3.463 19 1 16.537 1 13.5S3.463 8 6.5 8"/></IconWrapper>,
            HardDrive: (p) => <IconWrapper {...p}><line x1="22" x2="22" y1="12" y2="12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" x2="6.01" y1="16" y2="16"/><line x1="10" x2="10.01" y1="16" y2="16"/></IconWrapper>,
            Save: (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            Upload: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconWrapper>,
            Scan: (p) => <IconWrapper {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect width="10" height="6" x="7" y="9" rx="1"/></IconWrapper>,
            Barcode: (p) => <IconWrapper {...p}><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></IconWrapper>,
            ErrorIcon: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>,
            Plus: (p) => <IconWrapper {...p}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></IconWrapper>,
            Sun: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></IconWrapper>,
            Snowflake: (p) => <IconWrapper {...p}><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/><path d="m20 20-8-8-8 8"/><path d="m4 4 8 8 8-8"/></IconWrapper>,
            Leaf: (p) => <IconWrapper {...p}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.77 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></IconWrapper>,
            Sprout: (p) => <IconWrapper {...p}><path d="M7 20h10"/><path d="M10 20c5.5-2.5.8-6.4 3-10"/><path d="M9.5 9.4c1.1.8 1.8 2.2 2.3 3.7-2 .4-3.5.4-4.8-.3-1.2-.6-2.3-1.9-3-4.2 2.8-.5 4.4 0 5.5.8z"/><path d="M14.1 6a7 7 0 0 0-1.1 4c1.9-.1 3.3-.6 4.3-1.4 1-1 1.6-2.3 1.7-4.6-2.7.1-4 1-4.9 2z"/></IconWrapper>,
            List: (p) => <IconWrapper {...p}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconWrapper>,
            FileText: (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconWrapper>,
            GitMerge: (p) => <IconWrapper {...p}><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 0 0 9 9"/></IconWrapper>,
            Star: (p) => <IconWrapper {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></IconWrapper>,
            Award: (p) => <IconWrapper {...p}><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></IconWrapper>,
            Settings: (p) => <IconWrapper {...p}><path d="M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            Scale: (p) => <IconWrapper {...p}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></IconWrapper>
        };

        // --- AUDIO HELPER ---
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                const now = ctx.currentTime;

                switch (type) {
                    case 'success':
                        osc.type = "sine"; osc.frequency.setValueAtTime(1200, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        break;
                    case 'error':
                        osc.type = "square"; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                        break;
                    case 'add':
                        osc.type = "sine"; osc.frequency.setValueAtTime(800, now); osc.frequency.linearRampToValueAtTime(1000, now + 0.1); gain.gain.setValueAtTime(0.08, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        break;
                    case 'sub':
                        osc.type = "triangle"; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(300, now + 0.1); gain.gain.setValueAtTime(0.08, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        break;
                }
                osc.start(now); osc.stop(now + 0.2);
            } catch (e) { console.error("Audio play failed", e); }
        };

        // --- COMPONENTS ---
        
        // LOGIN SCREEN COMPONENT
        const LoginScreen = ({ onLogin, logoSrc, onLogoUpload }) => {
            const [pin, setPin] = useState("");
            const [error, setError] = useState(false);
            const [imgError, setImgError] = useState(false);

            const handleNum = (num) => {
                if (pin.length < 4) {
                    const newPin = pin + num;
                    setPin(newPin);
                    if (newPin.length === 4) {
                        setTimeout(() => {
                            if (newPin === "4647") {
                                onLogin();
                            } else {
                                setError(true);
                                playSound('error');
                                setTimeout(() => {
                                    setPin("");
                                    setError(false);
                                }, 400);
                            }
                        }, 200);
                    } else {
                        playSound('add');
                    }
                }
            };

            const handleDelete = () => {
                if (pin.length > 0) {
                    setPin(prev => prev.slice(0, -1));
                    playSound('sub');
                }
            };

            return (
                <div className="fixed inset-0 bg-[#0A0A0A] flex flex-col items-center justify-center p-4 z-[9999]">
                    <div className="mb-10 text-center animate-in flex flex-col items-center">
                        {/* Logo Upload Area */}
                        <div 
                            className="w-32 h-32 bg-[#1D1F23] rounded-full mb-6 flex items-center justify-center border border-[#3A4048] shadow-2xl relative overflow-hidden group cursor-pointer hover:border-indigo-500 transition-all"
                            onClick={() => document.getElementById('login-logo-upload').click()}
                            title="Click to change logo"
                        >
                            {!imgError && logoSrc ? (
                                <img 
                                    src={logoSrc} 
                                    alt="Logo" 
                                    className="w-full h-full object-cover" 
                                    onError={() => setImgError(true)} 
                                />
                            ) : (
                                <>
                                    <div className="absolute inset-0 bg-indigo-500/10 blur-xl"></div>
                                    <Icons.GlassWater size={48} className="text-indigo-500 relative z-10" />
                                </>
                            )}
                            
                            {/* Overlay for upload hint */}
                            <div className="absolute inset-0 bg-black/60 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <Icons.Upload size={24} className="text-white mb-1" />
                                <span className="text-[10px] text-white uppercase font-bold">Change</span>
                            </div>
                        </div>
                        <input type="file" id="login-logo-upload" accept="image/*" className="hidden" onChange={onLogoUpload} />

                        <h1 className="text-3xl font-black text-white mb-2 tracking-tight">Master Bar</h1>
                        <p className="text-[#f0f6fc]/40 text-[10px] font-medium uppercase tracking-widest">Access Control</p>
                    </div>

                    <div className={`flex gap-6 mb-12 ${error ? 'shake' : ''}`}>
                        {[0, 1, 2, 3].map(i => (
                            <div key={i} className={`w-4 h-4 rounded-full transition-all duration-300 border ${
                                pin.length > i 
                                    ? (error ? 'bg-red-500 border-red-500 scale-110 shadow-[0_0_15px_rgba(239,68,68,0.5)]' : 'bg-indigo-500 border-indigo-500 scale-110 shadow-[0_0_15px_rgba(99,102,241,0.5)]') 
                                    : 'bg-transparent border-[#3A4048]'
                            }`}></div>
                        ))}
                    </div>

                    <div className="grid grid-cols-3 gap-6 max-w-xs w-full">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                            <button 
                                key={num} 
                                onClick={() => handleNum(num.toString())} 
                                className="h-16 w-16 rounded-full text-2xl font-bold text-white bg-[#1D1F23] hover:bg-[#2A2D33] active:scale-90 transition-all border border-[#3A4048] shadow-lg flex items-center justify-center mx-auto"
                            >
                                {num}
                            </button>
                        ))}
                        <div className="h-16 w-16"></div>
                        <button onClick={() => handleNum("0")} className="h-16 w-16 rounded-full text-2xl font-bold text-white bg-[#1D1F23] hover:bg-[#2A2D33] active:scale-90 transition-all border border-[#3A4048] shadow-lg flex items-center justify-center mx-auto">0</button>
                        <button onClick={handleDelete} className="h-16 w-16 flex items-center justify-center text-[#f0f6fc]/40 hover:text-white active:scale-90 transition-all mx-auto">
                            <span className="text-xl font-bold">‚úï</span>
                        </button>
                    </div>
                    
                    <div className="mt-10 text-[#f0f6fc]/20 text-xs font-mono">v{APP_VERSION} Secure Access</div>
                </div>
            );
        };

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message, isDestructive, customActions }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-in">
                    <div className="bg-[#1D1F23] border border-[#3A4048] rounded-xl max-w-md w-full p-6 shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-2 flex items-center gap-2">
                            {isDestructive ? <Icons.AlertTriangle className="text-red-500" /> : <Icons.CheckCircle className="text-indigo-500" />}
                            {title}
                        </h3>
                        <p className="text-[#f0f6fc]/80 mb-6 whitespace-pre-line leading-relaxed">{message}</p>
                        
                        {customActions ? (
                            <div className="flex flex-col gap-3">
                                {customActions.map((action, idx) => (
                                    <button 
                                        key={idx} 
                                        onClick={action.onClick} 
                                        className={`w-full py-3 rounded-lg font-bold transition-all shadow-lg active:scale-95 ${action.class || 'bg-[#3A4048] text-white hover:bg-[#4A5462]'}`}
                                    >
                                        {action.label}
                                    </button>
                                ))}
                                <button onClick={onClose} className="w-full py-2 mt-2 text-[#f0f6fc]/50 hover:text-white text-xs font-medium">Cancel</button>
                            </div>
                        ) : (
                            <div className="flex justify-end gap-3">
                                <button onClick={onClose} className="px-4 py-2 rounded-lg bg-[#3A4048] text-[#f0f6fc]/80 hover:bg-[#4A5462] transition-colors border border-[#4A5462] font-medium">Cancel</button>
                                <button onClick={onConfirm} className={`px-4 py-2 rounded-lg text-white font-bold transition-colors shadow-lg ${isDestructive ? 'bg-red-600 hover:bg-red-500 shadow-red-900/20' : 'bg-indigo-600 hover:bg-indigo-500 shadow-indigo-900/20'}`}>Confirm</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // NEW: IMPORT MODAL (MERGE OR REPLACE)
        const ImportModal = ({ isOpen, onClose, onReplace, onMerge }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[70] backdrop-blur-md animate-in p-4">
                    <div className="bg-[#1D1F23] border border-[#3A4048] w-full max-w-md rounded-2xl shadow-2xl p-6">
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Icons.Upload className="text-indigo-400" /> Import File</h2>
                        <p className="text-[#f0f6fc]/70 mb-6">Data found in file. How would you like to process it?</p>
                        
                        <div className="flex flex-col gap-3">
                            <button onClick={onMerge} className="flex items-center justify-between p-4 bg-indigo-900/20 border border-indigo-500/50 rounded-xl hover:bg-indigo-900/40 transition-all group text-left">
                                <div>
                                    <div className="font-bold text-indigo-300 group-hover:text-indigo-200">Merge and Sum (Merge)</div>
                                    <div className="text-xs text-indigo-400/60 mt-1">Sums quantities to current inventory. Ideal for multi-device counts.</div>
                                </div>
                                <Icons.GitMerge className="text-indigo-400" />
                            </button>

                            <button onClick={onReplace} className="flex items-center justify-between p-4 bg-red-900/10 border border-red-500/30 rounded-xl hover:bg-red-900/20 transition-all group text-left">
                                <div>
                                    <div className="font-bold text-red-400 group-hover:text-red-300">Replace All</div>
                                    <div className="text-xs text-red-500/60 mt-1">Deletes current inventory and uses only file data.</div>
                                </div>
                                <Icons.Trash className="text-red-500" />
                            </button>
                        </div>
                        
                        <button onClick={onClose} className="w-full mt-6 py-2 rounded-lg bg-[#3A4048] text-[#f0f6fc]/60 font-medium hover:text-white hover:bg-[#4A5462]">Cancel</button>
                    </div>
                </div>
            );
        };

        const AddProductModal = ({ isOpen, onClose, onAdd, categories }) => {
            if (!isOpen) return null;
            const [name, setName] = useState("");
            const [category, setCategory] = useState(categories[0] || "");

            const handleSubmit = () => {
                if (!name.trim()) return;
                onAdd(name, category);
                setName("");
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-[60] backdrop-blur-md animate-in p-4">
                    <div className="bg-[#1D1F23] border border-[#3A4048] w-full max-w-md rounded-2xl shadow-2xl p-6">
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Icons.Plus className="text-indigo-400" /> Add New Product</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs text-[#f0f6fc]/60 font-bold uppercase mb-1">Product Name</label>
                                <input 
                                    type="text" 
                                    value={name} 
                                    onChange={(e) => setName(e.target.value)} 
                                    className="w-full bg-[#0A0A0A] border border-[#3A4048] rounded-lg px-3 py-3 text-white focus:outline-none focus:border-indigo-500 font-medium"
                                    placeholder="e.g., Havana Club"
                                    autoFocus
                                />
                            </div>
                            <div>
                                <label className="block text-xs text-[#f0f6fc]/60 font-bold uppercase mb-1">Category</label>
                                <select 
                                    value={category} 
                                    onChange={(e) => setCategory(e.target.value)}
                                    className="w-full bg-[#0A0A0A] border border-[#3A4048] rounded-lg px-3 py-3 text-white focus:outline-none focus:border-indigo-500 appearance-none font-medium"
                                >
                                    {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 py-3 rounded-xl bg-[#3A4048] text-[#f0f6fc]/80 font-bold hover:bg-[#4A5462] transition-colors">Cancel</button>
                            <button onClick={handleSubmit} className="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-500 shadow-lg shadow-indigo-900/30 transition-colors">Add Product</button>
                        </div>
                    </div>
                </div>
            );
        };

        const QuickEditModal = ({ item, onClose, onUpdate, initialLocation = 'bodega' }) => {
            if (!item) return null;
            const [activeField, setActiveField] = useState(initialLocation);
            
            // Define Zones Configuration
            const zonesConfig = {
                bar1: [
                    { id: 'bar1_cooler', label: 'Cooler', icon: 'üßä' },
                    { id: 'bar1_small_cooler_1', label: 'Small 1', icon: '‚ùÑÔ∏è' },
                    { id: 'bar1_small_cooler_2', label: 'Small 2', icon: '‚ùÑÔ∏è' },
                    { id: 'bar1_reaching', label: 'Reaching', icon: '‚úã' },
                    { id: 'bar1_shelf', label: 'Shelf', icon: 'üóÑÔ∏è' },
                    { id: 'bar1_well_1', label: 'Well 1', icon: 'ü•É' },
                    { id: 'bar1_well_2', label: 'Well 2', icon: 'ü•É' },
                ],
                bar2: [
                    { id: 'bar2_cooler', label: 'Cooler', icon: 'üßä' },
                    { id: 'bar2_small_cooler', label: 'Small Cooler', icon: '‚ùÑÔ∏è' },
                ],
                bodega: [
                    { id: 'bodega_closet', label: 'Closet', icon: 'üö™' },
                    { id: 'bodega_shelves', label: 'Shelves', icon: 'üóÑÔ∏è' },
                ]
            };

            const hasSubZones = zonesConfig[activeField] !== undefined;
            const currentZones = zonesConfig[activeField] || [];
            
            // Sub-zone state initialized with the first zone of the active location if applicable
            const [subZone, setSubZone] = useState(hasSubZones ? currentZones[0].id : null);

            // Scale state
            const [scaleWeight, setScaleWeight] = useState('');
            const [emptyW, setEmptyW] = useState(item.weight_empty || '');
            const [fullW, setFullW] = useState(item.weight_full || '');

            // --- NUEVO: L√≥gica para rastrear cu√°nto se agrega en esta sesi√≥n ---
            // Guardamos el valor inicial al abrir la ventana para calcular la diferencia
            const [sessionStartValue, setSessionStartValue] = useState(() => parseFloat(item[initialLocation]) || 0);

            // Funci√≥n para cambiar de ubicaci√≥n y resetear el contador de sesi√≥n
            const handleLocationChange = (locId) => {
                setActiveField(locId);
                const newZones = zonesConfig[locId];
                
                if (newZones) {
                    // If new location has zones, select the first one
                    const firstZoneId = newZones[0].id;
                    setSubZone(firstZoneId);
                    // Use item value? Note: session tracking logic for subzones is complex, keeping simple to main field for now or resetting
                    setSessionStartValue(parseFloat(item[locId]) || 0); 
                } else {
                    setSubZone(null);
                    setSessionStartValue(parseFloat(item[locId]) || 0);
                }
            };
            
            const handleSubZoneChange = (zoneId) => {
                setSubZone(zoneId);
            };

            // Determine what value we are editing
            const targetField = hasSubZones ? subZone : activeField;
            const currentValue = parseFloat(item[targetField]) || 0;
            const [lastDelta, setLastDelta] = useState(null);

            // Calculamos cu√°nto se ha agregado en esta sesi√≥n (Total Actual - Total Inicial)
            // Note: This logic tracks the TOTAL of the location (e.g. Bar1 Total), not subzone specific delta
            const currentTotalValue = parseFloat(item[activeField]) || 0;
            const addedThisSession = currentTotalValue - sessionStartValue;
            const addedSign = addedThisSession > 0 ? "+" : "";
            const addedColor = addedThisSession > 0 ? "text-emerald-400" : (addedThisSession < 0 ? "text-red-400" : "text-[#f0f6fc]/30");

            const handleDelta = (delta) => {
                if (delta > 0) playSound('add'); else playSound('sub');
                const next = Math.round((currentValue + delta) * 100) / 100; // Updated round logic for 2 decimals
                const newValue = Math.max(0, next);
                
                // Show visual feedback (+1 bubble)
                setLastDelta(delta);
                setTimeout(() => setLastDelta(null), 800);

                if (hasSubZones) {
                    // Update specific zone AND total for the location
                    const updates = { [subZone]: newValue };
                    
                    // Calculate new total for the location (sum all zones)
                    let newTotal = 0;
                    currentZones.forEach(z => {
                        if (z.id === subZone) newTotal += newValue;
                        else newTotal += (parseFloat(item[z.id]) || 0);
                    });
                    
                    // Round total to avoid float errors
                    newTotal = Math.round(newTotal * 100) / 100;
                    updates[activeField] = newTotal;
                    
                    onUpdate(item.id, updates);
                } else {
                    onUpdate(item.id, activeField, newValue);
                }
            };

            // Calculate scale value
            const calculateScaleValue = () => {
                const current = parseFloat(scaleWeight);
                const empty = parseFloat(emptyW);
                const full = parseFloat(fullW);

                if (!isNaN(current) && !isNaN(empty) && !isNaN(full)) {
                    if (current <= empty) return 0; // Empty or less
                    
                    const liquidFull = full - empty;
                    const liquidCurrent = current - empty;
                    
                    if (liquidFull <= 0) return 0; // Invalid full weight

                    let ratio = liquidCurrent / liquidFull;
                    // Clamp and Round
                    ratio = Math.max(0, Math.min(ratio, 1.1)); // Allow up to 110%
                    return Math.round(ratio * 100) / 100;
                }
                return null;
            };

            const calculatedScaleValue = calculateScaleValue();

            const handleApplyScale = () => {
                if (calculatedScaleValue !== null) {
                    // Save weights to item for future use
                    if (emptyW !== item.weight_empty || fullW !== item.weight_full) {
                         onUpdate(item.id, { weight_empty: emptyW, weight_full: fullW });
                    }
                    handleDelta(calculatedScaleValue);
                    setScaleWeight(''); // Reset input
                }
            };

            const locations = [
                { id: 'bodega', label: 'Storage' },
                { id: 'bar1', label: 'Bar 1' },
                { id: 'bar2', label: 'Bar 2' },
                { id: 'barroluco', label: 'Barroluco' },
                { id: 'purchases', label: 'Purchases' }
            ];
            
            // Check if item is bottle-based (simplistic check based on category name)
            const isBottle = item.category.includes("Liquor") || item.category.includes("Wine") || item.category.includes("Wells");

            return (
                <div className="fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-[60] backdrop-blur-md animate-in p-4">
                    <div className="bg-[#1D1F23] border border-[#3A4048] w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 bg-[#121212] border-b border-[#3A4048] flex justify-between items-center">
                            <div><h2 className="text-xl font-bold text-white leading-tight">{item.name}</h2><p className="text-xs text-[#f0f6fc]/50 font-mono mt-1">Quick Edit Mode</p></div>
                            <button onClick={onClose} className="bg-[#3A4048] hover:bg-[#4A5462] text-white p-2 rounded-full transition-colors"><span className="text-xl px-2">&times;</span></button>
                        </div>
                        
                        {/* Main Locations */}
                        <div className="p-2 bg-[#1D1F23] border-b border-[#3A4048] overflow-x-auto">
                            <div className="flex gap-2">
                                {locations.map(loc => (
                                    <button key={loc.id} onClick={() => handleLocationChange(loc.id)} className={`px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all ${activeField === loc.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50' : 'bg-[#3A4048] text-[#f0f6fc]/60 hover:bg-[#4A5462]'}`}>{loc.label}</button>
                                ))}
                            </div>
                        </div>

                        {/* Sub-Zones Selector (Dynamic) */}
                        {hasSubZones && (
                            <div className="p-2 bg-[#16181c] border-b border-[#3A4048] overflow-x-auto animate-in">
                                <div className="flex gap-2">
                                    {currentZones.map(zone => (
                                        <button 
                                            key={zone.id} 
                                            onClick={() => handleSubZoneChange(zone.id)} 
                                            className={`px-3 py-1.5 rounded-md text-[10px] uppercase font-bold whitespace-nowrap transition-all flex items-center gap-1 ${subZone === zone.id ? 'bg-indigo-500/20 text-indigo-300 border border-indigo-500/50' : 'bg-[#25282e] text-[#f0f6fc]/40 border border-transparent hover:bg-[#3A4048]'}`}
                                        >
                                            <span>{zone.icon}</span> {zone.label}
                                            <span className="bg-black/30 px-1.5 rounded ml-1 text-white">{parseFloat(item[zone.id]) || 0}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="flex-1 p-6 flex flex-col items-center justify-center bg-gradient-to-b from-[#1D1F23] to-[#121212] overflow-y-auto">
                            <div className="text-center mb-8 relative w-full">
                                <div className="text-[#f0f6fc]/50 text-sm uppercase font-bold tracking-wider mb-2">
                                    {hasSubZones 
                                        ? <span>Editing: <span className="text-indigo-400">{currentZones.find(z => z.id === subZone)?.label}</span></span>
                                        : <span>Total in {locations.find(l => l.id === activeField)?.label}</span>
                                    }
                                </div>
                                
                                {/* Contenedor Principal de N√∫meros */}
                                <div className="flex flex-col items-center justify-center">
                                    <div className="text-7xl font-black text-white font-mono tracking-tight tabular-nums relative inline-block">
                                        {currentValue}
                                        {lastDelta !== null && (
                                            <span className={`absolute -right-16 top-0 text-3xl font-bold ${lastDelta > 0 ? 'text-emerald-400' : 'text-red-400'} animate-float`}>
                                                {lastDelta > 0 ? '+' : ''}{lastDelta}
                                            </span>
                                        )}
                                    </div>
                                    
                                    {/* --- NUEVO: Indicador de "Agregado en esta sesi√≥n" --- */}
                                    <div className={`mt-2 px-4 py-1 rounded-full bg-[#0A0A0A] border border-[#3A4048] flex items-center gap-2 ${addedThisSession !== 0 ? 'opacity-100' : 'opacity-50'}`}>
                                        <span className="text-[10px] text-[#f0f6fc]/40 uppercase font-bold">Session Total:</span>
                                        <span className={`text-xl font-bold font-mono ${addedColor}`}>
                                            {addedSign}{Math.round(addedThisSession * 100) / 100}
                                        </span>
                                    </div>
                                </div>
                                
                                {hasSubZones && (
                                    <div className="mt-4 text-xs font-mono text-[#f0f6fc]/40">
                                        Total {locations.find(l => l.id === activeField)?.label} (Sum): <span className="text-white font-bold">{item[activeField] || 0}</span>
                                    </div>
                                )}

                            </div>
                            <div className="w-full grid grid-cols-2 gap-6">
                                <div className="flex flex-col gap-2 items-end">
                                    <button onClick={() => handleDelta(-24)} className="w-full bg-red-900/20 hover:bg-red-900/40 text-red-500 border border-red-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">- 24</button>
                                    <button onClick={() => handleDelta(-12)} className="w-full bg-red-900/20 hover:bg-red-900/40 text-red-500 border border-red-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">- 12</button>
                                    <button onClick={() => handleDelta(-6)} className="w-full bg-red-900/20 hover:bg-red-900/40 text-red-500 border border-red-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">- 6</button>
                                    <button onClick={() => handleDelta(-1)} className="w-full bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-900/40 py-3 rounded-xl font-black text-xl active:scale-95 transition-all">- 1</button>
                                    <button onClick={() => handleDelta(-0.1)} className="w-full bg-[#3A4048] hover:bg-[#4A5462] text-red-400 border border-[#4A5462] py-3 rounded-xl font-bold text-lg active:scale-95 transition-all">- 0.1</button>
                                </div>
                                <div className="flex flex-col gap-2 items-start">
                                    <button onClick={() => handleDelta(24)} className="w-full bg-emerald-900/20 hover:bg-emerald-900/40 text-emerald-500 border border-emerald-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">+ 24</button>
                                    <button onClick={() => handleDelta(12)} className="w-full bg-emerald-900/20 hover:bg-emerald-900/40 text-emerald-500 border border-emerald-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">+ 12</button>
                                    <button onClick={() => handleDelta(6)} className="w-full bg-emerald-900/20 hover:bg-emerald-900/40 text-emerald-500 border border-emerald-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">+ 6</button>
                                    <button onClick={() => handleDelta(1)} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/40 py-3 rounded-xl font-black text-xl active:scale-95 transition-all">+ 1</button>
                                    <button onClick={() => handleDelta(0.1)} className="w-full bg-[#3A4048] hover:bg-[#4A5462] text-emerald-400 border border-[#4A5462] py-3 rounded-xl font-bold text-lg active:scale-95 transition-all">+ 0.1</button>
                                </div>
                            </div>
                        </div>
                        <div className="p-4 bg-[#1D1F23] border-t border-[#3A4048]"><button onClick={onClose} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-900/30">Done</button></div>
                    </div>
                </div>
            );
        };

        const ShoppingListModal = ({ isOpen, onClose, items }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/90 flex flex-col z-50 backdrop-blur-sm animate-in overflow-hidden">
                    <div className="p-4 border-b border-[#3A4048] flex justify-between items-center bg-[#1D1F23]">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2"><Icons.ShoppingCart className="text-amber-500" /> Shopping List</h2>
                        <button onClick={onClose} className="p-2 bg-[#3A4048] text-[#f0f6fc]/80 rounded-lg hover:bg-[#4A5462]">Close</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4">
                        {items.length === 0 ? (
                            <div className="text-center text-[#f0f6fc]/50 mt-20"><p className="text-lg">All items are fully stocked!</p></div>
                        ) : (
                            <div className="grid gap-3">
                                {items.map((item, idx) => (
                                    <div key={idx} className="bg-[#1D1F23] p-4 rounded-xl border border-[#3A4048] flex justify-between items-center shadow-lg">
                                        <div>
                                            <h3 className="font-bold text-white text-lg">{item.name}</h3>
                                            <div className="text-xs text-[#f0f6fc]/50 font-mono mt-1">On Hand: <span className="text-emerald-400">{item.current}</span> / Target: <span className="text-blue-400">{item.target}</span></div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-[10px] text-amber-500 uppercase font-bold">To Buy</div>
                                            <div className="text-2xl font-black text-amber-400">{item.needed}</div>
                                            {item.details && <div className="text-[10px] text-[#f0f6fc]/60 font-mono mt-1">{item.details}</div>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="p-4 bg-[#1D1F23] border-t border-[#3A4048]"><p className="text-center text-xs text-[#f0f6fc]/50">Auto-Round: ‚â§0.5 Down, >0.5 Up</p></div>
                </div>
            );
        };

        // NEW COMPONENT: COUNT REVIEW MODAL
        const CountReviewModal = ({ isOpen, onClose, data, onUpdate }) => {
            if (!isOpen) return null;
            const [activeTab, setActiveTab] = useState('bar1');
            
            // Define Zones Configuration (Matches QuickEditModal)
            const zonesConfig = {
                bar1: [
                    { id: 'bar1_cooler', label: 'Cooler', icon: 'üßä' },
                    { id: 'bar1_small_cooler_1', label: 'Small 1', icon: '‚ùÑÔ∏è' },
                    { id: 'bar1_small_cooler_2', label: 'Small 2', icon: '‚ùÑÔ∏è' },
                    { id: 'bar1_reaching', label: 'Reaching', icon: '‚úã' },
                    { id: 'bar1_shelf', label: 'Shelf', icon: 'üóÑÔ∏è' },
                    { id: 'bar1_well_1', label: 'Well 1', icon: 'ü•É' },
                    { id: 'bar1_well_2', label: 'Well 2', icon: 'ü•É' },
                ],
                bar2: [
                    { id: 'bar2_cooler', label: 'Cooler', icon: 'üßä' },
                    { id: 'bar2_small_cooler', label: 'Small Cooler', icon: '‚ùÑÔ∏è' },
                ],
                bodega: [
                    { id: 'bodega_closet', label: 'Closet', icon: 'üö™' },
                    { id: 'bodega_shelves', label: 'Shelves', icon: 'üóÑÔ∏è' },
                ]
            };

            const hasSubZones = zonesConfig[activeTab] !== undefined;
            const currentZones = zonesConfig[activeTab] || [];
            
            // Default sub-zone: First available or null
            const [activeSubZone, setActiveSubZone] = useState(hasSubZones ? currentZones[0].id : null);
            
            // Effect to reset subzone when main tab changes
            useEffect(() => {
                if (zonesConfig[activeTab]) {
                    setActiveSubZone(zonesConfig[activeTab][0].id);
                } else {
                    setActiveSubZone(null);
                }
            }, [activeTab]);

            const locations = [
                { id: 'bar1', label: 'Bar 1' },
                { id: 'bar2', label: 'Bar 2' },
                { id: 'bodega', label: 'Storage' },
                { id: 'barroluco', label: 'Barroluco' }
            ];

            // Flatten items list for sequential view
            let flatItems = [];
            let totalCount = 0;

            // Determine which field to read from
            const fieldToRead = hasSubZones ? activeSubZone : activeTab;
            
            const locationLabel = hasSubZones 
                ? `${locations.find(l => l.id === activeTab)?.label} - ${currentZones.find(z => z.id === activeSubZone)?.label}` 
                : locations.find(l => l.id === activeTab)?.label;

            data.forEach(cat => {
                cat.items.forEach(item => {
                    const val = parseFloat(item[fieldToRead]);
                    // Show items if they have value OR if they were recently updated (to allow editing to 0)
                    // Simplified: Show if > 0. Editing to 0 will make it disappear on next open/refresh but stays while typing?
                    if (!isNaN(val) && val > 0) { 
                        flatItems.push({ 
                            ...item, 
                            val, 
                            categoryName: cat.category 
                        });
                    }
                });
            });

            // Sort by lastUpdated (Newest first to see what was just scanned)
            flatItems.sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
            totalCount = flatItems.length;

            const handleManualUpdate = (item, newValueStr) => {
                const newValue = parseFloat(newValueStr);
                
                // If simple update (no zones)
                if (!hasSubZones) {
                    onUpdate(item.id, fieldToRead, newValueStr);
                    return;
                }

                // If zones, we need to calculate total
                const currentZones = zonesConfig[activeTab];
                let newTotal = 0;
                
                currentZones.forEach(z => {
                    if (z.id === activeSubZone) {
                        newTotal += (parseFloat(newValueStr) || 0);
                    } else {
                        newTotal += (parseFloat(item[z.id]) || 0);
                    }
                });
                
                newTotal = Math.round(newTotal * 100) / 100;
                
                const updates = { 
                    [activeSubZone]: newValueStr,
                    [activeTab]: newTotal
                };
                
                onUpdate(item.id, updates);
            };

            return (
                <div className="fixed inset-0 bg-black/90 flex flex-col z-50 backdrop-blur-sm animate-in overflow-hidden">
                    <div className="p-4 border-b border-[#3A4048] flex justify-between items-center bg-[#1D1F23]">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2"><Icons.List className="text-blue-500" /> Count Double Check</h2>
                        <button onClick={onClose} className="p-2 bg-[#3A4048] text-[#f0f6fc]/80 rounded-lg hover:bg-[#4A5462]">Close</button>
                    </div>
                    
                    {/* Main Location Tabs */}
                    <div className="flex p-2 gap-2 overflow-x-auto bg-[#121212] border-b border-[#3A4048] no-scrollbar">
                        {locations.map(loc => (
                            <button 
                                key={loc.id} 
                                onClick={() => setActiveTab(loc.id)}
                                className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all ${activeTab === loc.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'bg-[#3A4048] text-[#f0f6fc]/60 hover:bg-[#4A5462]'}`}
                            >
                                {loc.label}
                            </button>
                        ))}
                    </div>

                    {/* Sub-Zone Tabs (Visible only if current tab has zones) */}
                    {hasSubZones && (
                        <div className="flex p-2 gap-2 overflow-x-auto bg-[#16181c] border-b border-[#3A4048] no-scrollbar shadow-inner">
                            {currentZones.map(zone => (
                                <button 
                                    key={zone.id} 
                                    onClick={() => setActiveSubZone(zone.id)}
                                    className={`px-3 py-1.5 rounded-md text-[10px] uppercase font-bold whitespace-nowrap transition-all flex items-center gap-1 ${activeSubZone === zone.id ? 'bg-indigo-500 text-white shadow-md' : 'bg-[#25282e] text-[#f0f6fc]/50 hover:bg-[#3A4048] border border-transparent'}`}
                                >
                                    <span>{zone.icon}</span> {zone.label}
                                </button>
                            ))}
                        </div>
                    )}

                    <div className="flex-1 overflow-y-auto p-4 bg-[#0A0A0A]">
                        {totalCount === 0 ? (
                            <div className="text-center text-[#f0f6fc]/50 mt-20 flex flex-col items-center">
                                <Icons.List size={48} className="mb-4 opacity-20" />
                                <p className="text-lg">No counted items in {locationLabel} yet.</p>
                                <p className="text-sm mt-2 opacity-50">Enter counts in the main inventory list to see them here.</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center px-1 border-b border-[#3A4048] pb-2">
                                    <div className="text-xs text-[#f0f6fc]/40 uppercase font-bold tracking-widest">Zone: <span className="text-white">{locationLabel}</span></div>
                                    <div className="text-xs text-[#f0f6fc]/40 uppercase font-bold tracking-widest">Items: {totalCount}</div>
                                </div>
                                
                                {flatItems.map((item, idx) => (
                                    <div key={item.id} className="bg-[#1D1F23] p-3 rounded-xl border border-[#3A4048] flex justify-between items-center shadow-sm hover:border-[#4A5462] transition-colors relative">
                                        {/* Order Indicator (Optional) */}
                                        <div className="absolute left-0 top-0 bottom-0 w-1 bg-indigo-600 rounded-l-xl"></div>
                                        
                                        <div className="flex-1 pl-3">
                                            <div className="text-[10px] text-indigo-400 font-bold uppercase tracking-wider mb-0.5">{item.categoryName}</div>
                                            <h4 className="font-bold text-white text-base leading-tight">{item.name}</h4>
                                            {item.lastUpdated && (
                                                <div className="text-[9px] text-[#f0f6fc]/30 font-mono mt-1">
                                                    {new Date(item.lastUpdated).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
                                                </div>
                                            )}
                                        </div>
                                        <div className="text-right bg-blue-900/20 px-2 py-1 rounded-lg border border-blue-500/30 min-w-[80px] flex flex-col justify-center">
                                            <div className="text-[9px] text-blue-400 uppercase font-bold text-center">Count</div>
                                            <input 
                                                type="number" 
                                                value={item.val} 
                                                onChange={(e) => handleManualUpdate(item, e.target.value)}
                                                onClick={(e) => e.target.select()}
                                                className="text-2xl font-black text-white bg-transparent text-center w-full focus:outline-none focus:text-indigo-400 no-spinners"
                                            />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ScannerModal = ({ onScanSuccess, onClose }) => {
            const [scanError, setScanError] = useState(null);
            const scannerRef = useRef(null);

            useEffect(() => {
                if (!window.Html5QrcodeScanner) { setScanError("Lib not loaded"); return; }
                const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
                if (!isSecure) { setScanError("Camera requires HTTPS."); return; }
                if (!scannerRef.current) {
                    try {
                        const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 }, false);
                        scannerRef.current = scanner;
                        scanner.render((decodedText) => { 
                            onScanSuccess(decodedText, scanner);
                        }, (error) => {});
                    } catch(err) { console.error(err); setScanError("Camera error."); }
                }
                return () => { 
                    if (scannerRef.current) {
                        try {
                            scannerRef.current.clear().catch(err => console.warn("Scanner clear error (safe to ignore)", err));
                        } catch(e) { console.warn(e); }
                    }
                };
            }, []);

            return (
                <div className="fixed inset-0 bg-black/95 flex flex-col z-50 animate-in">
                    <div className="p-4 flex justify-between items-center bg-[#1D1F23] border-b border-[#3A4048]">
                        <h3 className="text-white font-bold flex items-center gap-2"><Icons.Scan className="text-amber-500" /> Scan Barcode</h3>
                        <button onClick={onClose} className="text-[#f0f6fc]/50 hover:text-white px-3 py-1 rounded bg-[#3A4048]">Close</button>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center p-4 relative">
                        {scanError ? <div className="bg-red-900/50 border border-red-500 p-6 rounded-xl text-center max-w-sm text-red-200">{scanError}</div> : <div id="reader" className="w-full max-w-sm bg-black rounded-xl overflow-hidden border-2 border-indigo-500/50 shadow-2xl"></div>}
                        <div className="mt-6 text-[#f0f6fc]/40 text-sm font-medium">Position the barcode inside the box</div>
                    </div>
                </div>
            );
        };

        const ChartsView = ({ data, onClose }) => {
            const canvasRef = useRef(null);
            const chartInstance = useRef(null);

            const { activeItems, totals, categoryData } = useMemo(() => {
                let items = [];
                let totalConsumed = 0; 
                let totalSold = 0; 
                let totalDiff = 0;
                let catMap = {};

                data.forEach(cat => {
                    let catSales = 0; 
                    cat.items.forEach(item => {
                        const totalPhys = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
                        const totalStart = (parseFloat(item.start_bar1)||0) + (parseFloat(item.start_bar2)||0) + (parseFloat(item.start_bodega)||0) + (parseFloat(item.start_barroluco)||0);
                        const purchases = parseFloat(item.purchases)||0;
                        const sales = parseFloat(item.sales)||0;
                        const systemConsumption = totalStart + purchases - totalPhys;
                        const diff = sales - systemConsumption;
                        if (systemConsumption > 0 || sales > 0) {
                            items.push({ ...item, systemConsumption, sales, diff });
                            totalConsumed += systemConsumption; totalSold += sales; totalDiff += diff;
                            catSales += sales;
                        }
                    });
                    if (catSales > 0) catMap[cat.category] = catSales;
                });
                return { activeItems: items.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff)), totals: { totalConsumed, totalSold, totalDiff }, categoryData: catMap };
            }, [data]);

            useEffect(() => {
                if (canvasRef.current && window.Chart) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    const labels = Object.keys(categoryData);
                    const values = Object.values(categoryData);
                    const colors = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4', '#ef4444'];
                    chartInstance.current = new window.Chart(ctx, {
                        type: 'doughnut',
                        data: { labels: labels, datasets: [{ data: values, backgroundColor: colors, borderColor: '#0A0A0A', borderWidth: 2, hoverOffset: 4 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 11, family: 'monospace' }, boxWidth: 12 } }, title: { display: false } }, layout: { padding: 10 } }
                    });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [categoryData]);

            return (
                <div className="fixed inset-0 bg-[#0A0A0A] flex flex-col z-50 animate-in overflow-hidden">
                    <div className="p-4 border-b border-[#3A4048] flex justify-between items-center bg-[#1D1F23] backdrop-blur-md">
                        <h2 className="text-xl font-bold text-white flex items-center gap-3"><div className="p-2 bg-indigo-500/10 rounded-xl border border-indigo-500/20"><Icons.BarChart className="text-indigo-400" size={20} /></div>Performance Analytics</h2>
                        <button onClick={onClose} className="px-4 py-2 bg-[#3A4048] text-[#f0f6fc]/80 rounded-lg hover:bg-[#4A5462] hover:text-white transition-colors text-sm font-medium border border-[#4A5462]">Close</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="space-y-3 flex flex-col">
                                <div className="flex-1 bg-[#1D1F23] p-5 rounded-2xl border border-[#3A4048] shadow-lg flex flex-col justify-center">
                                    <div className="text-[11px] text-[#f0f6fc]/60 uppercase font-bold tracking-wider mb-2 flex items-center gap-2"><Icons.Package size={14} className="text-[#f0f6fc]/40"/> Total Consumed</div>
                                    <div className="text-4xl font-black text-white">{totals.totalConsumed.toFixed(1)}</div>
                                </div>
                                <div className="flex-1 bg-[#1D1F23] p-5 rounded-2xl border border-[#3A4048] shadow-lg flex flex-col justify-center">
                                    <div className="text-[11px] text-indigo-300 uppercase font-bold tracking-wider mb-2 flex items-center gap-2"><Icons.DollarSign size={14} className="text-indigo-500"/> Total Sales (POS)</div>
                                    <div className="text-4xl font-black text-indigo-400">{totals.totalSold.toFixed(1)}</div>
                                </div>
                                <div className={`flex-1 p-5 rounded-2xl border shadow-lg flex flex-col justify-center ${totals.totalDiff < 0 ? 'border-red-500/30 bg-red-900/10' : 'border-emerald-500/30 bg-emerald-900/10'} bg-[#1D1F23]`}>
                                    <div className={`text-[11px] uppercase font-bold tracking-wider mb-2 flex items-center gap-2 ${totals.totalDiff < 0 ? 'text-red-400' : 'text-emerald-400'}`}><Icons.RotateCcw size={14}/> Net Difference</div>
                                    <div className={`text-4xl font-black ${totals.totalDiff < 0 ? 'text-red-400' : 'text-emerald-400'}`}>{totals.totalDiff > 0 ? '+' : ''}{totals.totalDiff.toFixed(1)}</div>
                                </div>
                            </div>
                            <div className="bg-[#1D1F23] p-2 rounded-2xl border border-[#3A4048] shadow-lg min-h-[250px] relative flex flex-col">
                                <div className="absolute top-4 left-4 text-xs font-bold text-[#f0f6fc]/50 uppercase tracking-widest z-10">Sales Share</div>
                                <div className="flex-1 relative mt-4"><canvas ref={canvasRef}></canvas></div>
                                {Object.keys(categoryData).length === 0 && <div className="absolute inset-0 flex items-center justify-center text-[#f0f6fc]/50 text-sm">No sales data yet</div>}
                            </div>
                        </div>
                        <div className="space-y-3">
                            <h3 className="text-xs font-bold text-[#f0f6fc]/50 uppercase tracking-widest px-1 mt-6">Detailed Breakdown</h3>
                            {activeItems.length === 0 && <div className="text-center py-20 flex flex-col items-center opacity-50"><div className="p-6 rounded-full bg-[#1D1F23] mb-4 border border-[#3A4048]"><Icons.BarChart className="text-[#f0f6fc]/50" size={40} /></div><p className="text-[#f0f6fc]/50 font-medium">No active data found for this period.</p></div>}
                            {activeItems.map(item => {
                                const maxValue = Math.max(item.systemConsumption, item.sales, 1); 
                                const consumePercent = (item.systemConsumption / maxValue) * 100;
                                const salesPercent = (item.sales / maxValue) * 100;
                                const isLoss = item.diff < -0.1; const isGain = item.diff > 0.1;
                                return (
                                    <div key={item.id} className="bg-[#1D1F23] border border-[#3A4048] p-5 rounded-2xl relative overflow-hidden group hover:border-[#4A5462] transition-all shadow-md">
                                        {isLoss && <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-red-600 to-red-400"></div>}
                                        {isGain && <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-emerald-600 to-emerald-400"></div>}
                                        <div className="flex justify-between items-start mb-5 pl-2 relative z-10">
                                            <div>
                                                <div className="font-bold text-white text-lg leading-tight tracking-tight">{item.name}</div>
                                                <div className="text-[10px] text-[#f0f6fc]/50 font-mono mt-1 flex items-center gap-2">ID: {item.id} {isLoss && <span className="text-red-500 font-bold bg-red-900/20 px-1.5 rounded text-[9px] border border-red-900/50">LOSS</span>}</div>
                                            </div>
                                            <div className={`px-3 py-1.5 rounded-lg text-sm font-black font-mono border min-w-[60px] text-center shadow-sm ${isLoss ? 'bg-red-500/10 text-red-400 border-red-500/20' : isGain ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-[#3A4048] text-[#f0f6fc]/60 border-[#4A5462]'}`}>{item.diff > 0 ? '+' : ''}{item.diff.toFixed(2)}</div>
                                        </div>
                                        <div className="space-y-4 pl-2 relative z-10">
                                            <div className="relative">
                                                <div className="flex justify-between text-[11px] mb-1.5"><span className="text-[#f0f6fc]/60 font-bold uppercase tracking-wider">Inventory Used</span><span className="text-[#f0f6fc]/80 font-mono font-bold">{item.systemConsumption.toFixed(1)}</span></div>
                                                <div className="h-2.5 w-full bg-[#3A4048] rounded-full overflow-hidden border border-[#4A5462]"><div className="h-full bg-[#f0f6fc]/50 rounded-full opacity-50" style={{ width: `${consumePercent}%`, transition: 'width 1s ease-out' }}></div></div>
                                            </div>
                                            <div className="relative">
                                                <div className="flex justify-between text-[11px] mb-1.5"><span className={`${isLoss ? 'text-red-400' : 'text-indigo-400'} font-bold uppercase tracking-wider`}>POS Sales</span><span className={`${isLoss ? 'text-red-300' : 'text-indigo-300'} font-mono font-bold`}>{item.sales.toFixed(1)}</span></div>
                                                <div className="h-2.5 w-full bg-[#3A4048] rounded-full overflow-hidden border border-[#4A5462]"><div className={`h-full rounded-full shadow-[0_0_12px_rgba(0,0,0,0.5)] ${isLoss ? 'bg-gradient-to-r from-red-600 to-red-400 shadow-red-500/20' : 'bg-gradient-to-r from-indigo-600 to-indigo-400 shadow-indigo-500/20'}`} style={{ width: `${salesPercent}%`, transition: 'width 1s ease-out' }}></div></div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // üõ†Ô∏è UI COMPONENTS (Header, Row, Fields)
        // ==========================================

        const Header = ({ onNewPeriod, onClearAll, onDownload, onDownloadPDF, onShowCharts, onBackup, onRestore, isCloud, onShopping, logoSrc, onLogoUpload, onShowCount, isSaving, onToggleSearch, showSearch, onToggleZoneSelector, showZoneSelector }) => {
            const [showMenu, setShowMenu] = useState(false);
            const date = new Date();
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            let dateStr = date.toLocaleDateString('en-US', options);
            
            return (
                <header className="bg-[#1D1F23]/90 border-b border-[#3A4048] text-white p-4 shadow-xl backdrop-blur-sm sticky top-0 z-50">
                    <div className="max-w-6xl mx-auto flex flex-col lg:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-3 w-full lg:w-auto">
                            {/* Logo container: Removed padding (p-1) so image fills the circle completely */}
                            <div className="bg-[#3A4048] rounded-full border border-[#4A5462] shadow-lg overflow-hidden h-21 w-21 flex-shrink-0 cursor-pointer hover:border-indigo-500 transition-all relative group" onClick={() => document.getElementById('logo-upload').click()} title="Click to change logo">
                                <img src={logoSrc} alt="Logo" className="h-full w-full object-cover" onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/100x100/4f46e5/ffffff?text=LOGO"; }} />
                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-full"><Icons.Upload size={16} className="text-white" /></div>
                            </div>
                            <input type="file" id="logo-upload" accept="image/*" className="hidden" onChange={onLogoUpload} />
                            <div>
                                <h1 className="font-bold text-lg leading-tight text-white">Master Bar Control</h1>
                                <div className="flex items-center gap-2 text-xs mt-1 flex-wrap">
                                    <span className={`px-2 py-0.5 rounded-full border ${isCloud ? 'bg-indigo-900/50 border-indigo-500 text-indigo-200' : 'bg-[#3A4048] border-[#4A5462] text-[#f0f6fc]/50'} flex items-center gap-1 transition-colors`}>{isCloud ? <Icons.Cloud size={10} /> : <Icons.HardDrive size={10} />}{isCloud ? 'Cloud' : 'Local'}</span>
                                    {/* DATE MOVED HERE */}
                                    <span className="text-[#f0f6fc]/50 font-bold uppercase tracking-wider text-[10px] border-l border-[#3A4048] pl-2 ml-1">{dateStr}</span>
                                    
                                    {/* VERSION INDICATOR */}
                                    <span className="text-[#f0f6fc]/30 text-[9px] font-mono border-l border-[#3A4048] pl-2 ml-1">v{APP_VERSION}</span>

                                    {/* SAVING INDICATOR */}
                                    {isSaving && (
                                        <span className="ml-2 flex items-center gap-2 px-2 py-0.5 rounded-full bg-emerald-900/50 border border-emerald-500/50 text-emerald-300 text-[10px] font-bold uppercase animate-in">
                                            <div className="w-2 h-2 rounded-full bg-emerald-400 saving-pulse"></div> Saving...
                                        </span>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="flex flex-col lg:items-end gap-2 w-full lg:w-auto relative">
                            <div className="flex flex-wrap justify-center lg:justify-end gap-2 w-full lg:w-auto items-center">
                                {/* 1. TOGGLE SCANNER ZONES BUTTON */}
                                <button 
                                    onClick={onToggleZoneSelector} 
                                    className={`flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-5 py-2.5 rounded-xl font-bold border border-blue-400 text-sm shadow-lg shadow-blue-900/30 transition-all active:scale-95 ${showZoneSelector ? 'ring-2 ring-blue-500/50 scale-105' : ''}`}
                                    title="Open Scanner Zones"
                                >
                                    <Icons.Scan size={20} className="text-white" />
                                    <span>SCAN</span>
                                </button>

                                {/* 2. SEARCH BUTTON - ORANGE COLOR */}
                                <button onClick={onToggleSearch} className={`flex items-center justify-center bg-orange-600 hover:bg-orange-500 text-white w-11 h-11 rounded-xl font-bold shadow-lg shadow-orange-900/30 active:scale-95 border border-orange-400 transition-all ${showSearch ? 'ring-2 ring-orange-500/50 scale-105' : ''}`} title="Search Product">
                                    <Icons.Search size={22} />
                                </button>

                                {/* 3. COUNT BUTTON */}
                                <button onClick={onShowCount} className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-emerald-900/30 active:scale-95 text-sm border border-emerald-400"><Icons.List size={20} /> COUNT</button>

                                {/* 4. SETTINGS MENU BUTTON */}
                                <button 
                                    onClick={() => setShowMenu(!showMenu)} 
                                    className={`flex items-center justify-center w-11 h-11 rounded-xl font-bold shadow-lg active:scale-95 border transition-all ${showMenu ? 'bg-slate-600 text-white ring-2 ring-slate-500/50 scale-105' : 'bg-slate-700 hover:bg-slate-600 text-white border-slate-500 shadow-slate-900/30'}`}
                                    title="Settings & Tools"
                                >
                                    <Icons.Settings size={22} />
                                </button>
                            </div>

                            {/* --- DROPDOWN MENU --- */}
                            {showMenu && (
                                <>
                                    {/* Backdrop to close menu */}
                                    <div className="fixed inset-0 z-40" onClick={() => setShowMenu(false)}></div>
                                    <div className="absolute top-full right-0 mt-4 w-72 bg-[#1D1F23] border border-[#3A4048] rounded-3xl shadow-2xl z-50 p-3 flex flex-col gap-2 animate-in origin-top-right">
                                        <div className="text-[10px] text-[#f0f6fc]/40 uppercase font-bold tracking-widest px-3 py-2 border-b border-[#3A4048]/50 mb-1">Menu & Tools</div>
                                        
                                        {!isCloud && (
                                            <div className="flex gap-2 p-1">
                                                <button onClick={() => { onBackup(); setShowMenu(false); }} className="flex-1 flex items-center justify-center gap-2 bg-[#0A0A0A] hover:bg-[#3A4048] text-[#f0f6fc]/80 p-3 rounded-xl text-xs font-bold border border-[#3A4048] transition-all"><Icons.Save size={14} /> Backup</button>
                                                <button onClick={() => { onRestore(); setShowMenu(false); }} className="flex-1 flex items-center justify-center gap-2 bg-[#0A0A0A] hover:bg-[#3A4048] text-[#f0f6fc]/80 p-3 rounded-xl text-xs font-bold border border-[#3A4048] transition-all"><Icons.Upload size={14} /> Load</button>
                                            </div>
                                        )}

                                        {/* SHOP BUTTON (Moved inside menu) */}
                                        <button onClick={() => { onShopping(); setShowMenu(false); }} className="flex items-center gap-3 p-4 rounded-2xl hover:bg-[#3A4048] text-[#f0f6fc] transition-all text-base font-medium text-left">
                                            <Icons.ShoppingCart size={20} className="text-amber-400" /> Shopping List
                                        </button>

                                        <button onClick={() => { onShowCharts(); setShowMenu(false); }} className="flex items-center gap-3 p-4 rounded-2xl hover:bg-[#3A4048] text-[#f0f6fc] transition-all text-base font-medium text-left">
                                            <Icons.BarChart size={20} className="text-indigo-400" /> Performance Analytics
                                        </button>

                                        <button onClick={() => { onDownloadPDF(); setShowMenu(false); }} className="flex items-center gap-3 p-4 rounded-2xl hover:bg-[#3A4048] text-[#f0f6fc] transition-all text-base font-medium text-left">
                                            <Icons.FileText size={20} className="text-rose-400" /> Download PDF Report
                                        </button>

                                        <button onClick={() => { onNewPeriod(); setShowMenu(false); }} className="flex items-center gap-3 p-4 rounded-2xl hover:bg-[#3A4048] text-[#f0f6fc] transition-all text-base font-medium text-left">
                                            <Icons.ArrowRight size={20} className="text-emerald-400" /> Start Next Period
                                        </button>

                                        <div className="h-px bg-[#3A4048] my-1 mx-2"></div>

                                        <button onClick={() => { onClearAll(); setShowMenu(false); }} className="flex items-center gap-3 p-4 rounded-2xl hover:bg-red-900/20 text-red-400 transition-all text-base font-bold text-left group">
                                            <Icons.Trash size={20} className="group-hover:scale-110 transition-transform" /> Reset Inventory
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </header>
            );
        };

        const CategoryHeader = ({ title, icon: Icon, isOpen, toggle }) => (
            <button onClick={toggle} className="w-full flex items-center justify-between p-4 bg-[#1D1F23] border border-[#3A4048] hover:bg-[#1D1F23]/80 rounded-xl shadow-lg mb-2 transition-all group">
                <div className="flex items-center gap-3">
                    <div className="text-indigo-400 group-hover:text-indigo-300 transition-colors"><Icon size={20} /></div>
                    <h2 className="font-bold text-white text-lg group-hover:text-white transition-colors">{title}</h2>
                </div>
                {isOpen ? <Icons.ChevronUp className="text-[#f0f6fc]/50" /> : <Icons.ChevronDown className="text-[#f0f6fc]/50" />}
            </button>
        );

        const InputField = ({ label, value, onChange, colorClass = "border-[#30363d]", icon: Icon }) => (
            <div className="relative group">
                <label className="block text-[10px] text-[#f0f6fc]/60 font-bold uppercase mb-1 flex items-center gap-1 group-hover:text-indigo-400 transition-colors">{Icon && <Icon size={10} />} {label}</label>
                <input type="number" step="0.1" placeholder="-" value={value} onChange={(e) => onChange(e.target.value)} className={`w-full bg-[#0A0A0A] border rounded-lg px-3 py-2 font-mono text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500/50 focus:border-indigo-500 transition-all ${colorClass} ${value !== "" && value !== 0 ? 'text-indigo-300 font-bold border-indigo-500/50 bg-indigo-900/20' : 'text-[#f0f6fc]/50'}`} />
            </div>
        );
        
        const InventoryRow = ({ item, onUpdate, onLinkBarcode, pendingBarcode, isWells, categoryName, onScanRequest, onDelete }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const isUnitBased = categoryName.includes("Beers") || categoryName.includes("Seltzer") || categoryName.includes("Non Alcoholic");
            const totalPhys = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
            const totalStart = (parseFloat(item.start_bar1)||0) + (parseFloat(item.start_bar2)||0) + (parseFloat(item.start_bodega)||0) + (parseFloat(item.start_barroluco)||0);
            const purchases = parseFloat(item.purchases) || 0;
            const sales = parseFloat(item.sales) || 0;
            const systemConsumption = totalStart + purchases - totalPhys;
            const diff = sales - systemConsumption;
            const hasPhysical = item.bar1 || item.bar2 || item.bodega || item.barroluco;
            const hasStart = item.start_bar1 || item.start_bar2 || item.start_bodega || item.start_barroluco;
            const hasBarcode = !!item.barcode;
            const hasCaseBarcode = !!item.barcode_case;

            const bottleSizeOz = isWells ? 33.814 : 25.36;
            const shotsPerBottle = bottleSizeOz / 1.2; 
            
            const displayBarcode = item.barcode ? item.barcode.split(',')[0].trim() : "Unlinked";

            const handleSalesChange = (type, val) => {
                let newBottles = type === 'bottles' ? val : (item.sold_bottles || "");
                let newShots = type === 'shots' ? val : (item.sold_shots || "");
                let newComps = type === 'comps' ? val : (item.sold_comps || "");
                const b = parseFloat(newBottles) || 0; const s = parseFloat(newShots) || 0; const c = parseFloat(newComps) || 0;
                let totalSales = 0;
                if (isUnitBased) totalSales = b + (s * 6) + c;
                else totalSales = b + ((s * 1.2) / bottleSizeOz) + c;
                onUpdate(item.id, { sold_bottles: newBottles, sold_shots: newShots, sold_comps: newComps, sales: totalSales > 0 ? totalSales.toFixed(2) : "" });
            };
            
            const handleDirectSalesUpdate = (val) => { onUpdate(item.id, 'sales', val); };

            let statusColor = "bg-[#1D1F23] border-[#3A4048]"; 
            let badgeClass = "text-[#f0f6fc]/60 bg-[#0A0A0A] border border-[#3A4048]";
            
            if (hasPhysical && hasStart) {
                if (diff < -0.1) { statusColor = "bg-[#1D1F23] border-red-500/50 shadow-[inset_4px_0_0_0_#ef4444]"; badgeClass = "text-red-400 bg-red-900/20 border border-red-500/30"; }
                else if (diff > 0.1) { statusColor = "bg-[#1D1F23] border-blue-500/50 shadow-[inset_4px_0_0_0_#3b82f6]"; badgeClass = "text-blue-400 bg-blue-900/20 border border-blue-500/30"; }
                else { statusColor = "bg-[#1D1F23] border-emerald-500/50 shadow-[inset_4px_0_0_0_#10b981]"; badgeClass = "text-emerald-400 bg-emerald-900/20 border border-emerald-500/30"; }
            }

            return (
                <div className={`rounded-xl border shadow-lg transition-all duration-300 overflow-hidden ${statusColor} mb-3 relative z-10`}>
                    <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-[#1D1F23]/80 transition-colors" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex-1">
                            <div className="flex items-center gap-2">
                                <span className="font-bold text-white text-base">{item.name}</span>
                                {hasBarcode && <Icons.Barcode size={14} className="text-indigo-400" />}
                                {hasCaseBarcode && <Icons.Box size={14} className="text-amber-400" />}
                                {(hasPhysical && hasStart) ? <span className={`text-xs font-mono font-bold px-2 py-0.5 rounded-md ${badgeClass}`}>{diff > 0 ? "+" : ""}{diff.toFixed(1)}</span> : null}
                            </div>
                            <div className="text-xs text-[#f0f6fc]/50 mt-1 flex gap-3 font-mono">
                                <span>On Hand: <b className="text-white">{totalStart}</b></span><span className="text-[#f0f6fc]/40">|</span><span>Physical: <b className="text-white">{totalPhys}</b></span>
                            </div>
                        </div>
                        <div>{isExpanded ? <Icons.ChevronUp className="text-[#f0f6fc]/50" /> : <Icons.ChevronDown className="text-[#f0f6fc]/50" />}</div>
                    </div>
                    {isExpanded && (
                        <div className="p-4 border-t border-[#3A4048]/50 bg-[#0A0A0A]/50 space-y-4 animate-in">
                            <div className="space-y-2 mb-3">
                                <div className="flex items-center justify-between bg-[#0A0A0A] p-3 rounded-lg border border-[#3A4048]">
                                    <div className="flex items-center gap-2">
                                        <Icons.Barcode className="text-[#f0f6fc]/60" size={16} />
                                        <div className="flex flex-col">
                                            <span className="text-[10px] uppercase text-[#f0f6fc]/50 font-bold">Unit Barcode (CSV)</span>
                                            <span className="text-xs font-mono text-white">{displayBarcode}</span>
                                        </div>
                                    </div>
                                    <button onClick={() => onScanRequest(item.id, 'unit')} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs px-3 py-2 rounded-lg font-bold shadow-lg shadow-indigo-900/20 active:scale-95 transition-all">
                                        <Icons.Scan size={14} /> {item.barcode ? "Change/Add" : "Link Unit"}
                                    </button>
                                </div>
                                {isUnitBased && (
                                    <div className="flex items-center justify-between bg-[#0A0A0A] p-3 rounded-lg border border-[#3A4048]">
                                        <div className="flex items-center gap-2">
                                            <Icons.Box className="text-amber-500" size={16} />
                                            <div className="flex flex-col">
                                                <span className="text-[10px] uppercase text-amber-500/70 font-bold">Case Barcode (24pk)</span>
                                                <span className="text-xs font-mono text-white">{item.barcode_case || "Unlinked"}</span>
                                            </div>
                                        </div>
                                        <button onClick={() => onScanRequest(item.id, 'case')} className="flex items-center gap-2 bg-amber-700 hover:bg-amber-600 text-white text-xs px-3 py-2 rounded-lg font-bold shadow-lg shadow-amber-900/20 active:scale-95 transition-all">
                                            <Icons.Scan size={14} /> {item.barcode_case ? "Change" : "Link Case"}
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            <div className="bg-[#0A0A0A] p-3 rounded-lg border border-[#3A4048]">
                                <div className="flex items-center gap-2 mb-3 text-indigo-400 font-bold text-[10px] uppercase tracking-wider"><Icons.Box size={12} /> 1. On Hand (Start)</div>
                                <div className="grid grid-cols-4 gap-2">
                                    <InputField label="Bar 1" value={item.start_bar1} onChange={(v) => onUpdate(item.id, 'start_bar1', v)} colorClass="border-[#3A4048] focus:border-amber-500" />
                                    <InputField label="Bar 2" value={item.start_bar2} onChange={(v) => onUpdate(item.id, 'start_bar2', v)} colorClass="border-[#3A4048] focus:border-amber-500" />
                                    <InputField label="Storage" value={item.start_bodega} onChange={(v) => onUpdate(item.id, 'start_bodega', v)} colorClass="border-[#3A4048] focus:border-amber-500" />
                                    <InputField label="Barroluco" value={item.start_barroluco} onChange={(v) => onUpdate(item.id, 'start_barroluco', v)} colorClass="border-[#3A4048] focus:border-amber-500" />
                                </div>
                                <div className="text-right mt-2 text-xs font-bold text-amber-500/80">Total: {totalStart}</div>
                            </div>
                            <div className="bg-[#1D1F23] p-3 rounded-lg border border-[#3A4048]">
                                <div className="grid grid-cols-1 gap-3"><InputField label="2. Purchases (+)" value={item.purchases} onChange={(v) => onUpdate(item.id, 'purchases', v)} icon={Icons.ShoppingCart} colorClass="border-emerald-900/50 focus:border-emerald-500 text-emerald-300" /></div>
                            </div>
                            <div className="bg-[#0A0A0A] p-3 rounded-lg border border-[#3A4048]">
                                <div className="flex items-center gap-2 mb-3 text-indigo-400 font-bold text-[10px] uppercase tracking-wider"><Icons.MapPin size={12} /> 3. Physical Count (End)</div>
                                <div className="grid grid-cols-4 gap-2">
                                    <InputField label="Bar 1" value={item.bar1} onChange={(v) => onUpdate(item.id, 'bar1', v)} colorClass="border-[#3A4048] focus:border-indigo-500" />
                                    <InputField label="Bar 2" value={item.bar2} onChange={(v) => onUpdate(item.id, 'bar2', v)} colorClass="border-[#3A4048] focus:border-indigo-500" />
                                    <InputField label="Storage" value={item.bodega} onChange={(v) => onUpdate(item.id, 'bodega', v)} colorClass="border-[#3A4048] focus:border-indigo-500" />
                                    <InputField label="Barroluco" value={item.barroluco} onChange={(v) => onUpdate(item.id, 'barroluco', v)} colorClass="border-[#3A4048] focus:border-indigo-500" />
                                </div>
                                <div className="text-right mt-2 text-xs font-bold text-indigo-400">Total: {totalPhys}</div>
                            </div>
                            <div className="bg-amber-900/10 p-3 rounded-lg border border-amber-900/20">
                                <div className="flex items-center gap-2 mb-3 text-amber-500 font-bold text-[10px] uppercase tracking-wider"><Icons.Calculator size={12} /> 4. Sales Calculator (POS)</div>
                                <div className="mb-4 bg-amber-500/5 p-3 rounded border border-amber-500/10">
                                    <div className="text-[10px] text-amber-300 mb-1 uppercase font-bold">{isUnitBased ? "Unit Calculator" : `Shot Calculator (1.2oz @ ${isWells ? '1L' : '750ml'})`}</div>
                                    <div className="grid grid-cols-3 gap-3 mb-2">
                                        <div className="relative group"><label className="block text-[10px] text-amber-300/70 font-bold uppercase mb-1">{isUnitBased ? "Cans / Units" : "Bottles"}</label><input type="number" step="1" placeholder="0" value={item.sold_bottles || ""} onChange={(e) => handleSalesChange('bottles', e.target.value)} className="w-full bg-[#0A0A0A] border border-[#3A4048] rounded-lg px-2 py-2 font-mono text-sm focus:outline-none focus:border-amber-500 text-amber-100" /></div>
                                        <div className="relative group"><label className="block text-[10px] text-amber-300/70 font-bold uppercase mb-1">{isUnitBased ? "Buckets (x6)" : "Shots"}</label><input type="number" step="1" placeholder="0" value={item.sold_shots || ""} onChange={(e) => handleSalesChange('shots', e.target.value)} className="w-full bg-[#0A0A0A] border border-[#3A4048] rounded-lg px-2 py-2 font-mono text-sm focus:outline-none focus:border-amber-500 text-amber-100" /></div>
                                        <div className="relative group"><label className="block text-[10px] text-amber-300/70 font-bold uppercase mb-1">{isUnitBased ? "Comps (Units)" : "Comps (Bottles)"}</label><input type="number" step="1" placeholder="0" value={item.sold_comps || ""} onChange={(e) => handleSalesChange('comps', e.target.value)} className="w-full bg-[#0A0A0A] border border-emerald-700/50 rounded-lg px-2 py-2 font-mono text-sm focus:outline-none focus:border-emerald-500 text-emerald-100" /></div>
                                    </div>
                                    <div className="text-[9px] text-[#f0f6fc]/50 mt-1">{isUnitBased ? "Auto-updates. (1 Bucket = 6 Units) + Comps" : `Auto-updates. (1 Bottle = ${shotsPerBottle.toFixed(2)} Shots) + Comps`}</div>
                                </div>
                                <div className="grid grid-cols-1 gap-3"><InputField label="Total Sales POS (Calculated)" value={item.sales} onChange={(v) => handleDirectSalesUpdate(v)} icon={Icons.DollarSign} colorClass="border-blue-900/50 focus:border-blue-500 text-blue-300" /></div>
                                <div className="text-right mt-4 text-xs text-[#f0f6fc]/50 font-mono space-y-2">
                                    <div className="text-amber-500/80">Sys Sales = {totalStart} + {purchases || 0} - {totalPhys} = <b>{systemConsumption}</b></div>
                                    <div className={`text-xl font-black ${diff < 0 ? 'text-red-600' : 'text-emerald-600'}`}>Diff = {diff.toFixed(2)}</div>
                                </div>
                            </div>

                            <div className="flex justify-between items-center pt-4 border-t border-[#3A4048]/50 mt-2">
                                <div className="text-[9px] text-[#f0f6fc]/30 font-mono">ID: {item.id}</div>
                                <button 
                                    onClick={(e) => { e.stopPropagation(); onDelete(item); }}
                                    className="flex items-center gap-2 bg-red-900/10 hover:bg-red-900/30 text-red-500 hover:text-red-400 border border-red-900/30 px-3 py-1.5 rounded-lg text-xs font-bold transition-all"
                                >
                                    <Icons.Trash size={14} /> Delete
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const createItem = (id, name) => ({ 
            id, 
            name, 
            bar1: "", bar2: "", bodega: "", barroluco: "", 
            start_bar1: "", start_bar2: "", start_bodega: "", start_barroluco: "", 
            purchases: "", sales: "", 
            sold_bottles: "", sold_shots: "", sold_comps: "", 
            barcode: "", barcode_case: "",
            // Bar 1 Sub-zones
            bar1_cooler: "", bar1_small_cooler_1: "", bar1_small_cooler_2: "", 
            bar1_reaching: "", bar1_shelf: "", bar1_well_1: "", bar1_well_2: "",
            // Bar 2 Sub-zones
            bar2_cooler: "", bar2_small_cooler: "",
            // Bodega Sub-zones
            bodega_closet: "", bodega_shelves: "",
            // Weights
            weight_empty: "", weight_full: "",
            // Last Updated Timestamp
            lastUpdated: Date.now()
        });

        const INITIAL_DATA = [
            { category: "Premium Liquor (Tequila/Whisky)", items: [ createItem("liq-1", "Casamigos Blanco"), createItem("liq-2", "Casamigos Reposado"), createItem("liq-23", "Espolon Blanco"), createItem("liq-24", "Espolon Reposado"), createItem("liq-25", "Patron Cristalino"), createItem("liq-3", "Don Julio Blanco"), createItem("liq-4", "Don Julio Reposado"), createItem("liq-6", "Patron Silver"), createItem("liq-7", "Patron Reposado"), createItem("liq-8", "Clase Azul"), createItem("liq-9", "Grand Old Parr 12"), createItem("liq-11", "Crown Royal Regal"), createItem("liq-10", "Apple Crown Royal"), createItem("liq-26", "Hennessy VS"), createItem("liq-12", "Buchanans 12"), createItem("liq-13", "Johnnie Walker Black"), createItem("liq-14", "Capitan Morgan Spice"), createItem("liq-15", "Brugal Anejo"), createItem("liq-27", "Tito's Texas Vodka"), createItem("liq-16", "Grey Goose"), createItem("liq-17", "Jack Daniels Black"), createItem("liq-18", "WoodFord Reserve"), createItem("liq-19", "Fernet Branca"), createItem("liq-28", "Jagermeister"), createItem("liq-29", "Jameson"), createItem("liq-30", "Beefeater"), createItem("liq-32", "Wahaka Mezcal"), createItem("liq-31", "Malibu"), createItem("vin-4", "Moet Imperial Necta Rose"), createItem("liq-20", "Disaronno Amaretto"), createItem("vin-3", "Procecco Zonin"), createItem("liq-21", "Remy Martin"), createItem("liq-22", "Novo Fogo Silver Cachaca") ]},
            { category: "Wells (House Liquor)", items: [ 
                createItem("wel-1", "Bacardi Light"), 
                createItem("wel-2", "Bacardi Lime"), 
                createItem("wel-13", "Bacardi Limon"), 
                createItem("wel-3", "Pirassununga Cacha√ßa 51"), 
                {...createItem("wel-4", "Barton Naturals Vodka"), barcode: "123456789012,210987654321"}, 
                createItem("wel-15", "Barton Gin"), 
                createItem("wel-5", "Peach Schnapps Boston"), 
                createItem("wel-6", "Montezuma White"), 
                createItem("wel-7", "Triple Sec Boston"), 
                createItem("wel-8", "Long Island Tea Mix"), 
                createItem("wel-9", "Curacao Blue"), 
                createItem("wel-10", "Melon Boston"), 
                createItem("wel-14", "Sour Apple"), 
                createItem("wel-11", "Sour Apple HW"), 
                createItem("wel-12", "Sour Cherry Boston") 
            ]},
            { category: "Seltzer & Energy", items: [ 
                createItem("sel-1", "Red Bull Sugar Free"), 
                createItem("sel-2", "Red Bull Regular"), 
                createItem("sel-3", "Red Bull Watermelon"), 
                createItem("sel-4", "Red Bull Juneberry"), 
                {...createItem("sel-5", "High Noon Variety Pack"), barcode: "987654321098,876543210987"}
            ]},
            { category: "Beers", items: [ createItem("cer-1", "Pacifico"), createItem("cer-2", "Michelob Ultra"), createItem("cer-3", "Modelo Especial"), createItem("cer-5", "Corona"), createItem("cer-4", "Heineken") ]},
            { category: "Wines", items: [ createItem("vin-1", "Sangria"), createItem("vin-2", "Chardonnay El Enemigo"), createItem("vin-5", "Cafayate Malbec") ]},
            { category: "Non Alcoholic", items: [ createItem("na-1", "Coca Cola"), createItem("na-2", "Diet Coke"), createItem("na-3", "Sprite"), createItem("na-4", "Ginger Ale"), createItem("na-5", "Water Bottle") ]}
        ];

        function App() {
            // AUTH STATE
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            
            const [data, setData] = useState(INITIAL_DATA);
            const [loading, setLoading] = useState(true);
            const [isCloud, setIsCloud] = useState(false);
            const [user, setUser] = useState(null);
            
            // SAFE STORAGE USAGE
            const [logo, setLogo] = useState(() => SafeStorage.getItem('BAR_LOGO') || "A New Design (4).jpg");
            
            const fb = window.fb;
            const fileInputRef = useRef(null);
            const [scanningForItem, setScanningForItem] = useState(null); 
            const [scanAttempt, setScanAttempt] = useState(0); 
            const [isResetting, setIsResetting] = useState(false);
            const LOCAL_STORAGE_KEY = 'bar-inventory-final-v26'; 

            const [showAddProduct, setShowAddProduct] = useState(false);
            const [currentLocation, setCurrentLocation] = useState('bar1'); 
            const [showCountReview, setShowCountReview] = useState(false);
            const [showSearch, setShowSearch] = useState(false); 
            const [showZoneSelector, setShowZoneSelector] = useState(false); 
            
            // NEW: SAVING STATE
            const [isSaving, setIsSaving] = useState(false);
            const saveTimeoutRef = useRef(null);
            
            // NEW STATE FOR IMPORT MERGE
            const [pendingImportData, setPendingImportData] = useState(null);
            const [showImportModal, setShowImportModal] = useState(false);

            useEffect(() => {
                const initApp = async () => {
                    let firebaseSuccess = false;
                    
                    if (FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.apiKey !== "" && fb) {
                        try {
                            const app = fb.initializeApp(FIREBASE_CONFIG);
                            const auth = fb.getAuth(app);
                            const db = fb.getFirestore(app);
                            try { 
                                await fb.signInAnonymously(auth); 
                                firebaseSuccess = true;
                            } catch (authError) { 
                                console.warn("Firebase Auth failed, falling back to local");
                            }
                            
                            if (firebaseSuccess) {
                                fb.onAuthStateChanged(auth, (u) => {
                                    setUser(u);
                                    if (u) {
                                        setIsCloud(true);
                                        const docRef = fb.doc(db, 'inventory', 'master');
                                        fb.onSnapshot(docRef, (docSnap) => {
                                            if (docSnap.exists()) {
                                                if (!isSaving) {
                                                    setData(docSnap.data().items);
                                                }
                                            }
                                            else { fb.setDoc(docRef, { items: INITIAL_DATA }); setData(INITIAL_DATA); }
                                            setLoading(false);
                                        }, (err) => { 
                                            console.warn("Snapshot failed", err);
                                            setIsCloud(false); 
                                            loadLocal(); 
                                        });
                                    } else {
                                        loadLocal();
                                    }
                                });
                            } else {
                                loadLocal();
                            }
                        } catch (e) { 
                            console.warn("Firebase Init failed", e);
                            setIsCloud(false); 
                            loadLocal(); 
                        }
                    } else { 
                        setIsCloud(false); 
                        loadLocal(); 
                    }
                };
                const loadLocal = () => {
                    try {
                        const saved = SafeStorage.getItem(LOCAL_STORAGE_KEY);
                        if (saved) {
                            let loaded = JSON.parse(saved);
                            let updated = false;
                            INITIAL_DATA.forEach(initCat => {
                                let targetCat = loaded.find(c => c.category === initCat.category);
                                if (targetCat) {
                                    initCat.items.forEach(initItem => {
                                        if (!targetCat.items.find(i => i.id === initItem.id)) { targetCat.items.push(initItem); updated = true; }
                                    });
                                } else { loaded.push(initCat); updated = true; }
                            });
                            if (updated) SafeStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(loaded));
                            setData(loaded);
                        } else setData(INITIAL_DATA);
                    } catch(e) { console.warn("Local load failed", e); setData(INITIAL_DATA); }
                    setLoading(false);
                };
                initApp();
            }, []);

            // --- PDF GENERATION LOGIC ---
            const generatePDF = async () => {
                showNotification("Generating PDF...");
                
                // 1. Calculate Statistics
                let items = [];
                let totalConsumed = 0; 
                let totalSold = 0; 
                let totalDiff = 0;
                let catMap = {};

                data.forEach(cat => {
                    let catSales = 0;
                    cat.items.forEach(item => {
                        const totalPhys = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
                        const totalStart = (parseFloat(item.start_bar1)||0) + (parseFloat(item.start_bar2)||0) + (parseFloat(item.start_bodega)||0) + (parseFloat(item.start_barroluco)||0);
                        const purchases = parseFloat(item.purchases)||0;
                        const sales = parseFloat(item.sales)||0;
                        const systemConsumption = totalStart + purchases - totalPhys;
                        const diff = sales - systemConsumption;
                        
                        if (systemConsumption > 0 || sales > 0) {
                            items.push({ ...item, category: cat.category, totalStart, totalPhys, purchases, systemConsumption, sales, diff });
                            totalConsumed += systemConsumption; totalSold += sales; totalDiff += diff;
                            catSales += sales;
                        }
                    });
                    if (catSales > 0) catMap[cat.category] = catSales;
                });
                
                items.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));

                // 2. Generate Chart Image using hidden canvas
                const generateChartImage = () => {
                    return new Promise((resolve) => {
                        const canvas = document.getElementById('pdf-chart-canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Clear and set white background manually
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // Check if we have data
                        if (Object.keys(catMap).length === 0) {
                            resolve(null);
                            return;
                        }

                        const chart = new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: Object.keys(catMap),
                                datasets: [{
                                    data: Object.values(catMap),
                                    backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4', '#ef4444'],
                                    borderColor: '#ffffff',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                animation: false,
                                responsive: false, // Important for fixed canvas size
                                devicePixelRatio: 2, // Higher quality
                                plugins: {
                                    legend: { 
                                        display: true, 
                                        position: 'bottom', 
                                        labels: { 
                                            color: '#000000',
                                            font: { size: 14, family: 'Helvetica' },
                                            padding: 20
                                        } 
                                    },
                                    title: {
                                        display: true,
                                        text: 'Sales Distribution by Category',
                                        color: '#000000',
                                        font: { size: 18, weight: 'bold' },
                                        padding: { bottom: 20 }
                                    }
                                },
                                layout: {
                                    padding: 20
                                }
                            }
                        });
                        
                        // Wait slightly longer to ensure render cycle completes
                        setTimeout(() => {
                            try {
                                const imgData = canvas.toDataURL('image/jpeg', 1.0); // Use JPEG for better compatibility
                                chart.destroy();
                                resolve(imgData);
                            } catch (e) {
                                console.error("Chart export failed", e);
                                resolve(null);
                            }
                        }, 800);
                    });
                };

                const chartImg = await generateChartImage();

                // 3. Create PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                // Changed locale to en-US for English date format
                const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                // -- Header --
                doc.setFontSize(18);
                doc.setTextColor(40, 40, 40);
                doc.text("EXECUTIVE REPORT - PALMAS TROPICAL ESCAPE", 105, 20, { align: 'center' });
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Cutoff Date: ${dateStr}`, 105, 28, { align: 'center' });

                // -- Summary Box --
                doc.setDrawColor(200);
                doc.setFillColor(245, 247, 250);
                doc.rect(14, 35, 182, 30, 'F');
                doc.setDrawColor(220);
                doc.rect(14, 35, 182, 30, 'S');

                doc.setFontSize(10); doc.setTextColor(80);
                doc.text("Total Consumed", 40, 45, { align: 'center' });
                doc.text("Total Sold (POS)", 105, 45, { align: 'center' });
                doc.text("Net Difference", 170, 45, { align: 'center' });

                doc.setFontSize(14); doc.setTextColor(0); doc.setFont("helvetica", "bold");
                doc.text(totalConsumed.toFixed(2), 40, 55, { align: 'center' });
                doc.setTextColor(79, 70, 229); // Indigo
                doc.text(totalSold.toFixed(2), 105, 55, { align: 'center' });
                
                if (totalDiff < 0) doc.setTextColor(220, 38, 38); // Red
                else doc.setTextColor(22, 163, 74); // Green
                const sign = totalDiff > 0 ? '+' : '';
                doc.text(`${sign}${totalDiff.toFixed(2)}`, 170, 55, { align: 'center' });

                // -- Chart Image --
                if (chartImg && Object.keys(catMap).length > 0) {
                    try {
                        doc.addImage(chartImg, 'JPEG', 60, 70, 90, 90);
                    } catch (err) {
                        console.warn("Could not add image to PDF", err);
                    }
                }

                // -- Detailed Table --
                doc.autoTable({
                    startY: Object.keys(catMap).length > 0 ? 170 : 80,
                    // Translated Headers
                    head: [['Product', 'Cat', 'Start', 'Purchases', 'End', 'Usage', 'Sales', 'Diff']],
                    body: items.map(i => [
                        i.name, 
                        i.category.split(' ')[0], // Shorten category
                        i.totalStart,
                        i.purchases || 0,
                        i.totalPhys,
                        i.systemConsumption.toFixed(2),
                        i.sales.toFixed(2),
                        i.diff.toFixed(2)
                    ]),
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [31, 41, 55], textColor: 255 },
                    rowStyles: (row) => {
                       // Logic handled in didParseCell usually, but styles works too for static
                    },
                    didParseCell: function(data) {
                        if (data.section === 'body' && data.column.index === 7) { // Diff column
                            const val = parseFloat(data.cell.raw);
                            if (val < -0.1) {
                                data.cell.styles.fillColor = [254, 226, 226]; // Light Red
                                data.cell.styles.textColor = [185, 28, 28]; // Dark Red
                                data.cell.styles.fontStyle = 'bold';
                            } else if (val > 0.1) {
                                data.cell.styles.fillColor = [220, 252, 231]; // Light Green
                                data.cell.styles.textColor = [21, 128, 61]; // Dark Green
                                data.cell.styles.fontStyle = 'bold';
                            }
                        }
                    }
                });

                doc.save(`Report_Palmas_${dateStr.replace(/ /g, '_')}.pdf`);
                showNotification("PDF Downloaded!");
            };

            const downloadReport = () => {
                const dateObj = new Date();
                const safeDate = dateObj.toISOString().split('T')[0];
                const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                let items = []; let totalConsumed = 0; let totalSold = 0; let totalDiff = 0;
                data.forEach(cat => {
                    cat.items.forEach(item => {
                        const totalPhys = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
                        const totalStart = (parseFloat(item.start_bar1)||0) + (parseFloat(item.start_bar2)||0) + (parseFloat(item.start_bodega)||0) + (parseFloat(item.start_barroluco)||0);
                        const purchases = parseFloat(item.purchases)||0;
                        const sales = parseFloat(item.sales)||0;
                        const systemConsumption = totalStart + purchases - totalPhys;
                        const diff = sales - systemConsumption;
                        if (systemConsumption > 0 || sales > 0) {
                            items.push({ ...item, category: cat.category, totalStart, totalPhys, purchases, systemConsumption, sales, diff });
                            totalConsumed += systemConsumption; totalSold += sales; totalDiff += diff;
                        }
                    });
                });
                items.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));
                let csv = `EXECUTIVE REPORT - PALMAS TROPICAL ESCAPE\nCutoff Date: ${formattedDate}\n\nGENERAL SUMMARY\nTotal Consumed,${totalConsumed.toFixed(2)}\nTotal Sold (POS),${totalSold.toFixed(2)}\nNet Difference,${totalDiff.toFixed(2)}\n\nMOVEMENT DETAILS (Ordered by Impact)\nPRODUCT,CATEGORY,START,PURCHASES,PHYSICAL END,ACTUAL CONSUMPTION,POS SALES,DIFFERENCE,STATUS,BOTTLES SOLD,SHOTS SOLD,COMPS\n`;
                items.forEach(item => {
                    let status = "OK"; if (item.diff < -0.1) status = "LOSS"; if (item.diff > 0.1) status = "GAIN";
                    csv += `"${item.name}","${item.category}",${item.totalStart},${item.purchases},${item.totalPhys},${item.systemConsumption.toFixed(2)},${item.sales.toFixed(2)},${item.diff.toFixed(2)},${status},${item.sold_bottles || 0},${item.sold_shots || 0},${item.sold_comps || 0}\n`;
                });
                const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a"); link.href = url; link.setAttribute("download", `Analysis_Palmas_${safeDate}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); showNotification("Analytical Report Downloaded!");
            };

            const saveData = (newData) => {
                setData(newData); // Always update local immediately
                
                if (isCloud && user) {
                    setIsSaving(true);
                    
                    // Clear previous timer if exists (Debounce)
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                    }

                    // Set new timer - Wait 2 seconds of inactivity before sending to cloud
                    saveTimeoutRef.current = setTimeout(() => {
                        try {
                            const app = fb.initializeApp(FIREBASE_CONFIG);
                            const db = fb.getFirestore(app);
                            // Send the data captured in the closure
                            fb.setDoc(fb.doc(db, 'inventory', 'master'), { items: newData })
                                .then(() => {
                                    setIsSaving(false);
                                    // playSound('success'); // Optional: feedback sound on save
                                })
                                .catch(err => {
                                    console.error("Save error", err);
                                    setIsSaving(false);
                                });
                        } catch (e) {
                            console.error("Firebase error", e);
                            setIsSaving(false);
                        }
                    }, 2000); // 2 second delay
                    
                } else {
                    // Local Storage saves immediately
                    SafeStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(newData));
                }
            };

            const [searchTerm, setSearchTerm] = useState("");
            // CAMBIO: Inicializado vac√≠o para que todas las categor√≠as empiecen cerradas
            const [openCategories, setOpenCategories] = useState({});
            const [notification, setNotification] = useState(null);
            const [modalConfig, setModalConfig] = useState(null);
            const [showCharts, setShowCharts] = useState(false);
            const [showShopping, setShowShopping] = useState(false);
            const [shoppingItems, setShoppingItems] = useState([]);
            const [isScanning, setIsScanning] = useState(false);
            const [pendingBarcode, setPendingBarcode] = useState(null);
            const [quickScanItemId, setQuickScanItemId] = useState(null);

            const checkBarcodeMatch = (decodedText, item) => {
                if (item.barcode) {
                    return item.barcode.split(',').some(code => code.trim() === decodedText);
                }
                if (item.barcode_case) {
                    return item.barcode_case === decodedText;
                }
                return false;
            };

            const handleScanSuccess = (decodedText, scannerInstance) => {
                if (scanningForItem) {
                    playSound('success'); 
                    setIsScanning(false); 
                    const { id, type } = scanningForItem;
                    const targetField = type === 'case' ? 'barcode_case' : 'barcode';
                    const label = type === 'case' ? 'Case' : 'Unit';

                    // Update timestamp on scan link
                    const newData = data.map(cat => ({ 
                        ...cat, 
                        items: cat.items.map(item => {
                            if (item.id === id) {
                                const timestamp = Date.now();
                                if (type === 'unit') {
                                    const existingCodes = item.barcode ? item.barcode.split(',').map(c => c.trim()) : [];
                                    if (!existingCodes.includes(decodedText)) {
                                        const newBarcode = existingCodes.length > 0 ? `${item.barcode},${decodedText}` : decodedText;
                                        return { ...item, barcode: newBarcode, lastUpdated: timestamp };
                                    } 
                                    return { ...item, lastUpdated: timestamp };
                                }
                                return { ...item, [targetField]: decodedText, lastUpdated: timestamp };
                            }
                            return item;
                        }) 
                    }));
                    saveData(newData); 
                    showNotification(`${label} code linked!`); 
                    setScanningForItem(null); 
                    return;
                }
                
                let foundItem = null;
                for (const cat of data) { 
                    const match = cat.items.find(i => checkBarcodeMatch(decodedText, i)); 
                    if (match) { foundItem = match; break; } 
                }
                
                if (foundItem) { 
                    playSound('success'); 
                    setIsScanning(false); 
                    setQuickScanItemId(foundItem.id); 
                    showNotification(`Opening: ${foundItem.name} in ${currentLocation.toUpperCase()}`); 
                } else { 
                    playSound('error');
                    showNotification(`Code ${decodedText} not recognized`);
                    
                    setIsResetting(true); 
                    setTimeout(() => { setIsResetting(false); }, 500);
                }
            };

            const requestItemScan = (itemId, type = 'unit') => { setScanningForItem({ id: itemId, type }); setIsScanning(true); };

            const handleDeleteProduct = (item) => {
                setModalConfig({
                    title: "Delete Item?",
                    message: `Permanently remove "${item.name}" from the inventory list?`,
                    isDestructive: true,
                    onConfirm: () => {
                        const newData = data.map(cat => ({
                            ...cat,
                            items: cat.items.filter(i => i.id !== item.id)
                        }));
                        saveData(newData);
                        setModalConfig(null);
                        showNotification(`Deleted: ${item.name}`);
                    }
                });
            };

            const generateShoppingList = () => {
                const toBuy = [];
                data.forEach(cat => {
                    cat.items.forEach(item => {
                        const target = PAR_LEVELS[item.name];
                        if (target !== undefined) {
                            const current = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
                            const needed = target - current;
                            if (needed > 0) {
                                let displayQuantity = needed; let details = null;
                                const isBeer = cat.category.includes("Beers"); const isRedBull = item.name.includes("Red Bull");
                                const customRound = (val) => { const decimal = val - Math.floor(val); const cleanDecimal = parseFloat(decimal.toFixed(2)); return cleanDecimal > 0.5 ? Math.ceil(val) : Math.floor(val); };
                                if (isBeer || isRedBull) { const cases = customRound(needed / 24); displayQuantity = `${cases} Cases`; details = `(${needed} units needed)`; } else { displayQuantity = customRound(needed); }
                                toBuy.push({ name: item.name, current, target, needed: displayQuantity, details });
                            }
                        }
                    });
                });
                setShoppingItems(toBuy); setShowShopping(true);
            };

            const confirmNewPeriod = () => {
                setModalConfig({
                    title: "Start Next Period?", message: "Moves Physical to On Hand.\nClears Sales/Purchases.", isDestructive: false,
                    onConfirm: () => {
                        const newData = data.map(cat => ({
                            ...cat,
                            items: cat.items.map(item => {
                                const physBodega = parseFloat(item.bodega) || 0;
                                return { 
                                    ...item, 
                                    start_bar1: item.bar1 !== "" ? item.bar1 : 0, 
                                    start_bar2: item.bar2 !== "" ? item.bar2 : 0, 
                                    start_bodega: physBodega, 
                                    start_barroluco: item.barroluco !== "" ? item.barroluco : 0, 
                                    bar1: "", bar2: "", bodega: "", barroluco: "", 
                                    purchases: "", sales: "", 
                                    sold_bottles: "", sold_shots: "", sold_comps: "",
                                    // Reset sub-zones for new period
                                    bar1_cooler: "", bar1_small_cooler_1: "", bar1_small_cooler_2: "", 
                                    bar1_reaching: "", bar1_shelf: "", bar1_well_1: "", bar1_well_2: "",
                                    bar2_cooler: "", bar2_small_cooler: "",
                                    bodega_closet: "", bodega_shelves: ""
                                };
                            })
                        }));
                        saveData(newData); setModalConfig(null); showNotification("New Period Started!");
                    }
                });
            };

            const confirmClearAll = () => { 
                setModalConfig({ 
                    title: "Reset Inventory Options", 
                    message: "What type of reset do you want to perform?", 
                    isDestructive: true, 
                    customActions: [
                        {
                            label: "Counts Only (Keep Barcodes)",
                            class: "bg-indigo-600 hover:bg-indigo-500 text-white border border-indigo-500",
                            onClick: () => {
                                // ZERO OUT COUNTS BUT KEEP STRUCTURE AND BARCODES
                                const newData = data.map(cat => ({
                                    ...cat,
                                    items: cat.items.map(item => ({
                                        ...item,
                                        // Clear counts
                                        bar1: "", bar2: "", bodega: "", barroluco: "",
                                        start_bar1: "", start_bar2: "", start_bodega: "", start_barroluco: "",
                                        purchases: "", sales: "",
                                        sold_bottles: "", sold_shots: "", sold_comps: "",
                                        // Clear sub-zones
                                        bar1_cooler: "", bar1_small_cooler_1: "", bar1_small_cooler_2: "", 
                                        bar1_reaching: "", bar1_shelf: "", bar1_well_1: "", bar1_well_2: "",
                                        bar2_cooler: "", bar2_small_cooler: "",
                                        bodega_closet: "", bodega_shelves: ""
                                        // Barcodes are preserved implicitly
                                    }))
                                }));
                                saveData(newData); 
                                setModalConfig(null); 
                                showNotification("Counts Reset. Barcodes Saved.");
                            }
                        },
                        {
                            label: "Factory Reset (Delete All)",
                            class: "bg-red-600 hover:bg-red-500 text-white border border-red-500",
                            onClick: () => {
                                saveData(INITIAL_DATA); 
                                setModalConfig(null); 
                                showNotification("Factory Reset Complete."); 
                            }
                        }
                    ]
                }); 
            };
            
            const handleBackup = () => { const blob = new Blob([JSON.stringify(data)], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `Bar_Backup_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            
            // --- NEW: IMPORT LOGIC ---
            const handleRestoreFile = (e) => { 
                const file = e.target.files[0]; 
                if (!file) return; 
                const reader = new FileReader(); 
                reader.onload = (ev) => { 
                    try { 
                        const d = JSON.parse(ev.target.result); 
                        if (Array.isArray(d) && d[0].category) { 
                            // Instead of replacing immediately, set pending state and show modal
                            setPendingImportData(d);
                            setShowImportModal(true);
                        } else {
                             showNotification("Invalid file."); 
                        }
                    } catch(err) { showNotification("Error reading file."); } 
                }; 
                reader.readAsText(file); 
                e.target.value = null; 
            };

            const handleReplaceData = () => {
                if (pendingImportData) {
                    saveData(pendingImportData);
                    showNotification("Data replaced successfully!");
                    setShowImportModal(false);
                    setPendingImportData(null);
                }
            };

            const handleMergeData = () => {
                if (!pendingImportData) return;

                // Deep copy current data
                const newData = JSON.parse(JSON.stringify(data));
                let changesCount = 0;

                pendingImportData.forEach(incomingCat => {
                    let targetCat = newData.find(c => c.category === incomingCat.category);
                    if (!targetCat) {
                        // New category? Add it entire
                        newData.push(incomingCat);
                        changesCount++;
                        return;
                    }

                    incomingCat.items.forEach(incomingItem => {
                        let targetItem = targetCat.items.find(i => i.id === incomingItem.id);
                        if (!targetItem) {
                            // New item? Add it
                            targetCat.items.push(incomingItem);
                            changesCount++;
                        } else {
                            // MERGE LOGIC: Sum numeric fields
                            const numericFields = [
                                'bar1', 'bar2', 'bodega', 'barroluco', 
                                'start_bar1', 'start_bar2', 'start_bodega', 'start_barroluco',
                                'purchases', 'sales', 'sold_bottles', 'sold_shots', 'sold_comps',
                                'bar1_cooler', 'bar1_small_cooler_1', 'bar1_small_cooler_2', 'bar1_reaching', 'bar1_shelf', 'bar1_well_1', 'bar1_well_2',
                                'bar2_cooler', 'bar2_small_cooler',
                                'bodega_closet', 'bodega_shelves'
                            ];
                            
                            numericFields.forEach(field => {
                                const currentVal = parseFloat(targetItem[field]) || 0;
                                const incomingVal = parseFloat(incomingItem[field]) || 0;
                                
                                // Only update if there is something to add
                                if (incomingVal !== 0) {
                                    const sum = currentVal + incomingVal;
                                    // If result is 0, make it empty string to match UI style, otherwise string
                                    targetItem[field] = sum !== 0 ? sum.toString() : "";
                                    changesCount++;
                                }
                            });
                            
                            // Merge barcodes if missing
                            if (!targetItem.barcode && incomingItem.barcode) targetItem.barcode = incomingItem.barcode;
                            if (!targetItem.barcode_case && incomingItem.barcode_case) targetItem.barcode_case = incomingItem.barcode_case;
                        }
                    });
                });

                saveData(newData);
                showNotification("Merge successful! Data summed!");
                setShowImportModal(false);
                setPendingImportData(null);
            };

            const handleLogoChange = (e) => { const file = e.target.files[0]; if (!file) return; if (file.size > 2 * 1024 * 1024) { showNotification("Image too large. Please use an image under 2MB."); return; } const reader = new FileReader(); reader.onload = (ev) => { const base64 = ev.target.result; setLogo(base64); SafeStorage.setItem('BAR_LOGO', base64); showNotification("Logo Updated!"); }; reader.readAsDataURL(file); };
            
            // --- UPDATED: With Timestamp Logic ---
            const updateItem = (itemId, fieldOrObj, value) => { 
                const newData = data.map(cat => ({ 
                    ...cat, 
                    items: cat.items.map(item => { 
                        if (item.id === itemId) { 
                            const timestamp = Date.now(); // Track when it was updated
                            if (typeof fieldOrObj === 'object' && fieldOrObj !== null) return { ...item, ...fieldOrObj, lastUpdated: timestamp }; 
                            return { ...item, [fieldOrObj]: value, lastUpdated: timestamp }; 
                        } 
                        return item; 
                    }) 
                })); 
                saveData(newData); 
            };
            
            const showNotification = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };

            const handleAddNewProduct = (name, category) => {
                const newId = `custom-${Date.now()}`;
                const newItem = createItem(newId, name);
                const newData = data.map(cat => {
                    if (cat.category === category) {
                        return { ...cat, items: [...cat.items, newItem] };
                    }
                    return cat;
                });
                saveData(newData);
                showNotification(`Added: ${name}`);
            };
            
            // --- UPDATED: Sort by Last Updated Logic ---
            const filteredData = useMemo(() => {
                const normalize = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const term = searchTerm ? normalize(searchTerm) : "";
                const tightTerm = term.replace(/\s+/g, '');

                return data.map(cat => {
                    // 1. Filter items
                    const filteredItems = cat.items.filter(item => {
                        if (!term) return true;
                        const nameMatch = normalize(item.name).includes(term);
                        const catMatch = normalize(cat.category).includes(term);
                        const tightName = normalize(item.name).replace(/\s+/g, '');
                        const tightMatch = tightName.includes(tightTerm);
                        return nameMatch || catMatch || tightMatch;
                    });

                    // 2. Sort items: Most recently updated first
                    // Items with no update (0) stay at bottom, or respect original order
                    const sortedItems = filteredItems.sort((a, b) => {
                        const timeA = a.lastUpdated || 0;
                        const timeB = b.lastUpdated || 0;
                        if (timeA === timeB) return 0; // Keep original relative order if no diff
                        return timeB - timeA; // Descending (Newest first)
                    });

                    return { ...cat, items: sortedItems };
                }).filter(cat => cat.items.length > 0);
            }, [data, searchTerm]);

            const getIcon = (n) => { if (n.includes("Premium")) return Icons.GlassWater; if (n.includes("Wells")) return Icons.Package; if (n.includes("Beers")) return Icons.Beer; if (n.includes("Wines")) return Icons.Wine; if (n.includes("Non Alcoholic")) return Icons.Leaf; return Icons.RefreshCw; };
            const activeQuickItem = useMemo(() => { if (!quickScanItemId) return null; for (const cat of data) { const found = cat.items.find(i => i.id === quickScanItemId); if (found) return found; } return null; }, [data, quickScanItemId]);

            if (loading) return <div className="flex items-center justify-center min-h-screen text-[#f0f6fc]/50">Loading...</div>;

            // AUTH GUARD
            if (!isAuthenticated) {
                return (
                    <ErrorBoundary>
                        <LoginScreen 
                            onLogin={() => {
                                setIsAuthenticated(true);
                                playSound('success');
                            }} 
                            logoSrc={logo}
                            onLogoUpload={handleLogoChange}
                        />
                    </ErrorBoundary>
                );
            }

            return (
                <div className="min-h-screen bg-transparent font-sans pb-20">
                    <div className="sticky top-0 left-0 right-0 z-50 shadow-xl bg-[#1D1F23]/90 backdrop-blur-md">
                        <Header 
                            onNewPeriod={confirmNewPeriod} 
                            onClearAll={confirmClearAll} 
                            onDownload={downloadReport}
                            onDownloadPDF={generatePDF} 
                            onShowCharts={() => setShowCharts(true)} 
                            onBackup={handleBackup} 
                            onRestore={() => fileInputRef.current.click()} 
                            isCloud={isCloud} 
                            // onScan eliminado de aqu√≠
                            onShopping={generateShoppingList} 
                            logoSrc={logo} 
                            onLogoUpload={handleLogoChange}
                            onAddProduct={() => setShowAddProduct(true)}
                            onShowCount={() => setShowCountReview(true)}
                            isSaving={isSaving}
                            onToggleSearch={() => setShowSearch(!showSearch)}
                            showSearch={showSearch}
                            onToggleZoneSelector={() => setShowZoneSelector(!showZoneSelector)}
                            showZoneSelector={showZoneSelector}
                        />
                        
                        {/* --- NEW LOCATION CONTEXT SWITCHER --- */}
                        {showZoneSelector && (
                            <div className="bg-[#121212]/95 border-b border-[#3A4048] p-3 animate-in">
                                <div className="max-w-[360px] mx-auto bg-[#1D1F23] rounded-xl border border-[#3A4048] p-2 shadow-lg">
                                    <div className="flex justify-between items-center mb-2 px-1">
                                        <span className="text-[10px] text-indigo-400 uppercase font-bold tracking-widest flex items-center gap-2">
                                            <Icons.Scan size={12} /> SELECT ZONE TO SCAN
                                        </span>
                                        <span className="text-[9px] text-[#f0f6fc]/30 font-mono">
                                            CURRENT: {currentLocation.toUpperCase()}
                                        </span>
                                    </div>
                                    
                                    <div className="grid grid-cols-5 gap-2"> 
                                    {[
                                        {id: 'bar1', label: 'Bar 1'},
                                        {id: 'bar2', label: 'Bar 2'},
                                        {id: 'bodega', label: 'Storage'},
                                        {id: 'barroluco', label: 'Barroluco'},
                                        {id: 'purchases', label: 'Purchases'},
                                    ].map(loc => (
                                        <button 
                                            key={loc.id}
                                            onClick={() => {
                                                setCurrentLocation(loc.id);
                                                setIsScanning(true);
                                                setScanAttempt(0);
                                                setShowZoneSelector(false); // Close selector after choosing
                                            }}
                                            className={`aspect-square rounded-lg text-[8px] font-bold transition-all border flex flex-col items-center justify-center gap-1 ${currentLocation === loc.id 
                                                ? 'bg-indigo-600 border-indigo-500 text-white shadow-[0_0_10px_rgba(79,70,229,0.4)] scale-105' 
                                                : 'bg-[#0A0A0A] border-[#3A4048] text-[#f0f6fc]/50 hover:bg-[#3A4048] hover:text-white hover:border-indigo-500/50'}`}
                                        >
                                            <Icons.Scan size={16} className={currentLocation === loc.id ? "text-white" : "text-indigo-500/50"}/>
                                            <span className="truncate w-full text-center leading-none">{loc.label}</span>
                                        </button>
                                    ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* TOGGLEABLE SEARCH BAR */}
                        {showSearch && (
                            <div className="bg-[#0A0A0A]/90 p-4 border-b border-[#3A4048] backdrop-blur-sm animate-in">
                                <div className="max-w-5xl mx-auto relative flex gap-2">
                                    <div className="relative flex-1">
                                        <Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-[#f0f6fc]/50" size={20} />
                                        <input 
                                            type="text" 
                                            placeholder="Search product..." 
                                            value={searchTerm} 
                                            onChange={(e) => setSearchTerm(e.target.value)} 
                                            className="w-full bg-[#1D1F23] rounded-xl pl-10 pr-4 py-3 text-white border border-[#3A4048] focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all placeholder:text-[#f0f6fc]/40" 
                                            autoFocus
                                        />
                                    </div>
                                    <button 
                                        onClick={() => { setShowSearch(false); setSearchTerm(""); }} 
                                        className="bg-[#3A4048] hover:bg-[#4A5462] text-white px-4 rounded-xl font-bold border border-[#4A5462]"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                    <input type="file" ref={fileInputRef} style={{display:'none'}} accept=".json" onChange={handleRestoreFile} />
                    
                    
                    <main className="max-w-5xl mx-auto p-4 space-y-4 pt-6">
                        {filteredData.length === 0 && <div className="text-center py-20 text-[#f0f6fc]/50"><p>No products found.</p></div>}
                        {filteredData.map((cat) => (
                            <div key={cat.category} className="mb-6">
                                {!searchTerm && <CategoryHeader title={cat.category} icon={getIcon(cat.category)} isOpen={openCategories[cat.category]} toggle={() => setOpenCategories(prev => ({...prev, [cat.category]: !prev[cat.category]}))} />}
                                {(openCategories[cat.category] || searchTerm) && (
                                    <div className="grid gap-2 sm:grid-cols-1 lg:grid-cols-2">
                                        {cat.items.map(item => (<InventoryRow key={item.id} item={item} onUpdate={updateItem} pendingBarcode={pendingBarcode} isWells={cat.category.includes("Wells")} categoryName={cat.category} onScanRequest={requestItemScan} onDelete={handleDeleteProduct} />))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </main>
                    
                    <button 
                        onClick={() => setShowAddProduct(true)}
                        className="fixed bottom-6 right-6 z-40 bg-indigo-600 text-white p-4 rounded-full shadow-2xl hover:bg-indigo-500 transition-transform active:scale-95 border border-indigo-400 group"
                        title="Add New Product"
                    >
                        <Icons.Plus size={28} />
                    </button>

                    <ConfirmationModal 
                        isOpen={!!modalConfig} 
                        onClose={() => setModalConfig(null)} 
                        onConfirm={modalConfig?.onConfirm} 
                        title={modalConfig?.title} 
                        message={modalConfig?.message} 
                        isDestructive={modalConfig?.isDestructive} 
                        customActions={modalConfig?.customActions}
                    />
                    <ImportModal isOpen={showImportModal} onClose={() => { setShowImportModal(false); setPendingImportData(null); }} onReplace={handleReplaceData} onMerge={handleMergeData} />
                    <AddProductModal isOpen={showAddProduct} onClose={() => setShowAddProduct(false)} onAdd={handleAddNewProduct} categories={data.map(c => c.category)} />
                    {showCharts && <ChartsView data={data} onClose={() => setShowCharts(false)} />}
                    {showShopping && <ShoppingListModal isOpen={showShopping} onClose={() => setShowShopping(false)} items={shoppingItems} />}
                    {showCountReview && <CountReviewModal isOpen={showCountReview} onClose={() => setShowCountReview(false)} data={data} onUpdate={updateItem} />}
                    
                    {isScanning && !isResetting && (
                        <ScannerModal 
                            key={scanAttempt}
                            onScanSuccess={handleScanSuccess} 
                            onClose={() => { setIsScanning(false); setScanningForItem(null); }} 
                        />
                    )}
                    
                    {quickScanItemId && activeQuickItem && (
                        <QuickEditModal 
                            item={activeQuickItem} 
                            onClose={() => { 
                                setQuickScanItemId(null); 
                                setIsScanning(true);
                                setScanAttempt(0);
                            }} 
                            onUpdate={updateItem} 
                            initialLocation={currentLocation}
                        />
                    )}
                    
                    {notification && (
                        <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-[#1D1F23] text-white px-6 py-3 rounded-full shadow-2xl border border-[#3A4048] flex items-center gap-3 animate-in z-[100] whitespace-nowrap">
                            <Icons.CheckCircle size={18} className="text-emerald-400" />
                            <span className="font-medium text-sm">{notification}</span>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>